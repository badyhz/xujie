<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>人格成长模拟器</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f9fafc;
      --card: #ffffff;
      --text: #333;
      --muted: #6c757d;
      --primary: #4dabf7;
      --success: #37b24d;
      --warning: #f59f00;
      --danger: #fa5252;
      --info: #1c7ed6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Noto Sans SC", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 16px;
      font-size: 28px;
      color: #222;
    }

    .subtitle {
      text-align: center;
      color: var(--muted);
      font-size: 15px;
      margin-bottom: 30px;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .panel {
      background: var(--card);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }

    h2 {
      font-size: 20px;
      margin-bottom: 16px;
      color: var(--primary);
    }

    canvas {
      max-width: 100%;
      height: 400px;
    }

    .slider-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #e0e0e0;
      outline: none;
    }

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }

    button {
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s ease;
      width: 100%;
      max-width: 300px;
    }

    button.prev {
      background: var(--muted);
      color: #fff;
    }

    button.next {
      background: var(--primary);
      color: #fff;
    }

    button.prev:hover,
    button.next:hover {
      opacity: 0.85;
      transform: translateY(-1px);
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🌐 交互式人格成长模拟器</h1>
    <p class="subtitle">基于您的自评问卷和环境标签，调整以下维度，模拟不同情境下的人格变化。</p>

    <div class="grid">
      <!-- 左侧：人格地图 -->
      <div class="panel">
        <h2>🧭 人格立体图谱</h2>
        <canvas id="mapChart"></canvas>
      </div>

      <!-- 右侧：调节面板 -->
      <div class="panel">
        <h2>🎚️ 调节面板</h2>
        <div id="sliders"></div>
      </div>
    </div>

    <div class="nav-buttons">
      <button class="prev" onclick="location.href='report.html'">⬅ 上一步：查看报告</button>
      <button class="next" onclick="showToast('✅ 模拟结束，可以导出报告')">完成并导出 ➡</button>
    </div>
  </div>

  <div class="toast" id="toast">操作成功</div>

  <script>
    class DashboardApp {
      constructor() {
        // 1. 从 localStorage 加载数据
        this.selfScores = JSON.parse(localStorage.getItem("selfScores")) || [50, 50, 50, 50, 50];
        this.selectedTags = JSON.parse(localStorage.getItem("selectedTags")) || [];
        this.zodiac = localStorage.getItem("zodiac") || "未知";

        // 2. 定义大五人格维度
        this.B5_DIMENSIONS = ["开放性", "尽责性", "外向性", "宜人性", "神经质"];

        // 3. 初始化核心状态 (以问卷自评分为基础)
        this.STATE = {
          // 核心人格 (直接来自 step1)
          core: {
            开放性: this.selfScores[0],
            尽责性: this.selfScores[1],
            外向性: this.selfScores[2],
            宜人性: this.selfScores[3],
            神经质: this.selfScores[4]
          },
          // 环境与行为影响
          environment: {
            适应力: 50,
            熵增: 50,
            策略: 50
          },
          // 生态位与角色倾向
          ecology: {
            创造型: 50,
            稳定型: 60,
            竞争型: 45,
            共情型: 55,
            冒险型: 40,
            分析型: 65,
            协调型: 50,
            自律型: 55
          }
        };

        // 4. 根据用户选择的标签，微调初始状态
        this.adjustInitialState();
      }

      // 根据用户标签调整初始状态
      adjustInitialState() {
        if (this.selectedTags.length === 0) return;

        // 计算平均权重
        const avgWeight = this.selectedTags.reduce((sum, tag) => sum + (tag.weight || 5), 0) / this.selectedTags.length;

        // 1. 调整核心人格：如果平均权重高，说明环境影响大，核心人格可能更“社会化”
        Object.keys(this.STATE.core).forEach(dim => {
          // 环境影响越大，核心人格越趋于“中庸”或“稳定”
          this.STATE.core[dim] = Math.round(this.STATE.core[dim] + (5 - avgWeight) * 2);
        });

        // 2. 调整环境维度
        this.STATE.environment.适应力 = Math.round(50 + (avgWeight - 5) * 3);
        this.STATE.environment.熵增 = Math.round(50 + (5 - avgWeight) * 3); // 与适应力相反

        // 3. 调整生态位维度
        // 例如：选择“创业失败”、“重大失败”等标签，可能提升“冒险型”和“分析型”
        const hasFailureTag = this.selectedTags.some(tag => 
          tag.label.includes("失败") || tag.label.includes("挫折") || tag.label.includes("破产")
        );
        if (hasFailureTag) {
          this.STATE.ecology.冒险型 = Math.min(100, this.STATE.ecology.冒险型 + 10);
          this.STATE.ecology.分析型 = Math.min(100, this.STATE.ecology.分析型 + 15);
        }
      }

      // 获取所有维度的当前值，用于图表
      getAllScores() {
        return {
          ...this.STATE.core,
          ...this.STATE.environment,
          ...this.STATE.ecology
        };
      }

      // 初始化图表
      initChart() {
        const ctx = document.getElementById("mapChart");
        this.chart = new Chart(ctx, {
          type: "radar",
           {
            labels: Object.keys(this.getAllScores()),
            datasets: [{
              label: "当前人格状态",
              data: Object.values(this.getAllScores()),
              backgroundColor: "rgba(77, 171, 247, 0.3)",
              borderColor: "#4dabf7",
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 100,
                ticks: { stepSize: 20 }
              }
            },
            plugins: {
              legend: { position: 'top' },
              // 添加数据点提示
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed.r;
                    return `${context.label}: ${value}`;
                  }
                }
              }
            }
          }
        });
      }

      // 生成所有滑块
      renderSliders() {
        const container = document.getElementById("sliders");
        container.innerHTML = "";

        // 为每个维度生成滑块
        Object.entries(this.getAllScores()).forEach(([key, value]) => {
          const div = document.createElement("div");
          div.className = "slider-group";
          div.innerHTML = `
            <label>${key}: <span id="val-${key}">${value}</span></label>
            <input type="range" min="0" max="100" value="${value}" 
                   oninput="app.updateValue('${key}', this.value)" 
                   class="slider-input">
          `;
          container.appendChild(div);
        });
      }

      // 更新指定维度的值
      updateValue(key, val) {
        val = Number(val);

        if (this.STATE.core[key] !== undefined) {
          this.STATE.core[key] = val;
        } else if (this.STATE.environment[key] !== undefined) {
          this.STATE.environment[key] = val;
        } else if (this.STATE.ecology[key] !== undefined) {
          this.STATE.ecology[key] = val;
        }

        // 更新页面显示
        document.getElementById(`val-${key}`).textContent = val;
        // 更新图表
        this.chart.data.datasets[0].data = Object.values(this.getAllScores());
        this.chart.update();
      }

      // 显示Toast通知
      showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      // 初始化应用
      init() {
        this.initChart();
        this.renderSliders();
      }
    }

    // 启动应用
    document.addEventListener("DOMContentLoaded", () => {
      window.app = new DashboardApp();
      app.init();
    });
  </script>
</body>
</html>