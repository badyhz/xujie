<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äººæ ¼æˆé•¿æ¨¡æ‹Ÿå™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f9fafc;
      --card: #ffffff;
      --text: #333;
      --muted: #6c757d;
      --primary: #4dabf7;
      --success: #37b24d;
      --warning: #f59f00;
      --danger: #fa5252;
      --info: #1c7ed6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Noto Sans SC", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 16px;
      font-size: 28px;
      color: #222;
    }

    .subtitle {
      text-align: center;
      color: var(--muted);
      font-size: 15px;
      margin-bottom: 30px;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .panel {
      background: var(--card);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }

    h2 {
      font-size: 20px;
      margin-bottom: 16px;
      color: var(--primary);
    }

    canvas {
      max-width: 100%;
      height: 400px;
    }

    .slider-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #e0e0e0;
      outline: none;
    }

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }

    button {
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s ease;
      width: 100%;
      max-width: 300px;
    }

    button.prev {
      background: var(--muted);
      color: #fff;
    }

    button.next {
      background: var(--primary);
      color: #fff;
    }

    button.prev:hover,
    button.next:hover {
      opacity: 0.85;
      transform: translateY(-1px);
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ äº¤äº’å¼äººæ ¼æˆé•¿æ¨¡æ‹Ÿå™¨</h1>
    <p class="subtitle">åŸºäºæ‚¨çš„è‡ªè¯„é—®å·å’Œç¯å¢ƒæ ‡ç­¾ï¼Œè°ƒæ•´ä»¥ä¸‹ç»´åº¦ï¼Œæ¨¡æ‹Ÿä¸åŒæƒ…å¢ƒä¸‹çš„äººæ ¼å˜åŒ–ã€‚</p>

    <div class="grid">
      <!-- å·¦ä¾§ï¼šäººæ ¼åœ°å›¾ -->
      <div class="panel">
        <h2>ğŸ§­ äººæ ¼ç«‹ä½“å›¾è°±</h2>
        <canvas id="mapChart"></canvas>
      </div>

      <!-- å³ä¾§ï¼šè°ƒèŠ‚é¢æ¿ -->
      <div class="panel">
        <h2>ğŸšï¸ è°ƒèŠ‚é¢æ¿</h2>
        <div id="sliders"></div>
      </div>
    </div>

    <div class="nav-buttons">
      <button class="prev" onclick="location.href='report.html'">â¬… ä¸Šä¸€æ­¥ï¼šæŸ¥çœ‹æŠ¥å‘Š</button>
      <button class="next" onclick="showToast('âœ… æ¨¡æ‹Ÿç»“æŸï¼Œå¯ä»¥å¯¼å‡ºæŠ¥å‘Š')">å®Œæˆå¹¶å¯¼å‡º â¡</button>
    </div>
  </div>

  <div class="toast" id="toast">æ“ä½œæˆåŠŸ</div>

  <script>
    class DashboardApp {
      constructor() {
        // 1. ä» localStorage åŠ è½½æ•°æ®
        this.selfScores = JSON.parse(localStorage.getItem("selfScores")) || [50, 50, 50, 50, 50];
        this.selectedTags = JSON.parse(localStorage.getItem("selectedTags")) || [];
        this.zodiac = localStorage.getItem("zodiac") || "æœªçŸ¥";

        // 2. å®šä¹‰å¤§äº”äººæ ¼ç»´åº¦
        this.B5_DIMENSIONS = ["å¼€æ”¾æ€§", "å°½è´£æ€§", "å¤–å‘æ€§", "å®œäººæ€§", "ç¥ç»è´¨"];

        // 3. åˆå§‹åŒ–æ ¸å¿ƒçŠ¶æ€ (ä»¥é—®å·è‡ªè¯„åˆ†ä¸ºåŸºç¡€)
        this.STATE = {
          // æ ¸å¿ƒäººæ ¼ (ç›´æ¥æ¥è‡ª step1)
          core: {
            å¼€æ”¾æ€§: this.selfScores[0],
            å°½è´£æ€§: this.selfScores[1],
            å¤–å‘æ€§: this.selfScores[2],
            å®œäººæ€§: this.selfScores[3],
            ç¥ç»è´¨: this.selfScores[4]
          },
          // ç¯å¢ƒä¸è¡Œä¸ºå½±å“
          environment: {
            é€‚åº”åŠ›: 50,
            ç†µå¢: 50,
            ç­–ç•¥: 50
          },
          // ç”Ÿæ€ä½ä¸è§’è‰²å€¾å‘
          ecology: {
            åˆ›é€ å‹: 50,
            ç¨³å®šå‹: 60,
            ç«äº‰å‹: 45,
            å…±æƒ…å‹: 55,
            å†’é™©å‹: 40,
            åˆ†æå‹: 65,
            åè°ƒå‹: 50,
            è‡ªå¾‹å‹: 55
          }
        };

        // 4. æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æ ‡ç­¾ï¼Œå¾®è°ƒåˆå§‹çŠ¶æ€
        this.adjustInitialState();
      }

      // æ ¹æ®ç”¨æˆ·æ ‡ç­¾è°ƒæ•´åˆå§‹çŠ¶æ€
      adjustInitialState() {
        if (this.selectedTags.length === 0) return;

        // è®¡ç®—å¹³å‡æƒé‡
        const avgWeight = this.selectedTags.reduce((sum, tag) => sum + (tag.weight || 5), 0) / this.selectedTags.length;

        // 1. è°ƒæ•´æ ¸å¿ƒäººæ ¼ï¼šå¦‚æœå¹³å‡æƒé‡é«˜ï¼Œè¯´æ˜ç¯å¢ƒå½±å“å¤§ï¼Œæ ¸å¿ƒäººæ ¼å¯èƒ½æ›´â€œç¤¾ä¼šåŒ–â€
        Object.keys(this.STATE.core).forEach(dim => {
          // ç¯å¢ƒå½±å“è¶Šå¤§ï¼Œæ ¸å¿ƒäººæ ¼è¶Šè¶‹äºâ€œä¸­åº¸â€æˆ–â€œç¨³å®šâ€
          this.STATE.core[dim] = Math.round(this.STATE.core[dim] + (5 - avgWeight) * 2);
        });

        // 2. è°ƒæ•´ç¯å¢ƒç»´åº¦
        this.STATE.environment.é€‚åº”åŠ› = Math.round(50 + (avgWeight - 5) * 3);
        this.STATE.environment.ç†µå¢ = Math.round(50 + (5 - avgWeight) * 3); // ä¸é€‚åº”åŠ›ç›¸å

        // 3. è°ƒæ•´ç”Ÿæ€ä½ç»´åº¦
        // ä¾‹å¦‚ï¼šé€‰æ‹©â€œåˆ›ä¸šå¤±è´¥â€ã€â€œé‡å¤§å¤±è´¥â€ç­‰æ ‡ç­¾ï¼Œå¯èƒ½æå‡â€œå†’é™©å‹â€å’Œâ€œåˆ†æå‹â€
        const hasFailureTag = this.selectedTags.some(tag => 
          tag.label.includes("å¤±è´¥") || tag.label.includes("æŒ«æŠ˜") || tag.label.includes("ç ´äº§")
        );
        if (hasFailureTag) {
          this.STATE.ecology.å†’é™©å‹ = Math.min(100, this.STATE.ecology.å†’é™©å‹ + 10);
          this.STATE.ecology.åˆ†æå‹ = Math.min(100, this.STATE.ecology.åˆ†æå‹ + 15);
        }
      }

      // è·å–æ‰€æœ‰ç»´åº¦çš„å½“å‰å€¼ï¼Œç”¨äºå›¾è¡¨
      getAllScores() {
        return {
          ...this.STATE.core,
          ...this.STATE.environment,
          ...this.STATE.ecology
        };
      }

      // åˆå§‹åŒ–å›¾è¡¨
      initChart() {
        const ctx = document.getElementById("mapChart");
        this.chart = new Chart(ctx, {
          type: "radar",
           {
            labels: Object.keys(this.getAllScores()),
            datasets: [{
              label: "å½“å‰äººæ ¼çŠ¶æ€",
              data: Object.values(this.getAllScores()),
              backgroundColor: "rgba(77, 171, 247, 0.3)",
              borderColor: "#4dabf7",
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 100,
                ticks: { stepSize: 20 }
              }
            },
            plugins: {
              legend: { position: 'top' },
              // æ·»åŠ æ•°æ®ç‚¹æç¤º
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed.r;
                    return `${context.label}: ${value}`;
                  }
                }
              }
            }
          }
        });
      }

      // ç”Ÿæˆæ‰€æœ‰æ»‘å—
      renderSliders() {
        const container = document.getElementById("sliders");
        container.innerHTML = "";

        // ä¸ºæ¯ä¸ªç»´åº¦ç”Ÿæˆæ»‘å—
        Object.entries(this.getAllScores()).forEach(([key, value]) => {
          const div = document.createElement("div");
          div.className = "slider-group";
          div.innerHTML = `
            <label>${key}: <span id="val-${key}">${value}</span></label>
            <input type="range" min="0" max="100" value="${value}" 
                   oninput="app.updateValue('${key}', this.value)" 
                   class="slider-input">
          `;
          container.appendChild(div);
        });
      }

      // æ›´æ–°æŒ‡å®šç»´åº¦çš„å€¼
      updateValue(key, val) {
        val = Number(val);

        if (this.STATE.core[key] !== undefined) {
          this.STATE.core[key] = val;
        } else if (this.STATE.environment[key] !== undefined) {
          this.STATE.environment[key] = val;
        } else if (this.STATE.ecology[key] !== undefined) {
          this.STATE.ecology[key] = val;
        }

        // æ›´æ–°é¡µé¢æ˜¾ç¤º
        document.getElementById(`val-${key}`).textContent = val;
        // æ›´æ–°å›¾è¡¨
        this.chart.data.datasets[0].data = Object.values(this.getAllScores());
        this.chart.update();
      }

      // æ˜¾ç¤ºToasté€šçŸ¥
      showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      // åˆå§‹åŒ–åº”ç”¨
      init() {
        this.initChart();
        this.renderSliders();
      }
    }

    // å¯åŠ¨åº”ç”¨
    document.addEventListener("DOMContentLoaded", () => {
      window.app = new DashboardApp();
      app.init();
    });
  </script>
</body>
</html>