<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>äººæ ¼åˆ†ææŠ¥å‘Š</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #222;
      --primary: #4dabf7;
      --primary-light: #e6f4ff;
      --primary-dark: #3a9cf0;
      --border: #edf2ff;
      --muted: #6c757d;
      --success: #4caf50;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      margin: 0;
      font-family: "Noto Sans SC", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
    }
    header {
      text-align: center;
      padding: 24px;
      background: linear-gradient(135deg, var(--primary), #66b3ff);
      color: white;
      border-radius: 16px;
      margin-bottom: 24px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    .sub {
      font-size: 15px;
      opacity: 0.9;
    }
    .section {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      padding: 20px;
      margin-bottom: 20px;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: var(--primary);
    }
    .section-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .chip {
      background: var(--primary-light);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 6px 12px;
      font-size: 13px;
      color: var(--primary-dark);
    }
    .progress-item {
      margin-bottom: 12px;
    }
    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .progress-bar {
      height: 12px;
      background: #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      border-radius: 6px;
      width: 0%;
      transition: width 0.8s ease;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th {
      background: var(--primary);
      color: white;
      padding: 10px;
      text-align: left;
      font-weight: 600;
    }
    td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }
    tr:nth-child(even) {
      background: #f8f9fa;
    }
    .score {
      font-weight: 600;
      color: var(--primary-dark);
    }
    .highlight {
      color: var(--success);
      font-weight: 600;
    }
    .chart-container {
      position: relative;
      height: 320px;
      margin-top: 16px;
    }
    footer {
      text-align: center;
      margin-top: 40px;
      color: var(--muted);
      font-size: 13px;
      display: flex;
      justify-content: center;
      gap: 16px;
    }
    button {
      padding: 10px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: var(--primary-dark);
    }
    .btn-ghost {
      background: #e9ecef;
      color: #222;
    }
    .btn-ghost:hover {
      background: #d0d0d0;
    }
    .error {
      color: red;
      text-align: center;
      padding: 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ‘¤ ä½ çš„ç»¼åˆäººæ ¼ç”»åƒæŠ¥å‘Š</h1>
      <div class="sub">åŸºäº80é“è‡ªè¯„é¢˜ + 200ä¸ªè¡Œä¸ºæ ‡ç­¾çš„æ·±åº¦åˆ†æ</div>
    </header>

    <div id="errorBox"></div>

    <!-- ğŸŒŸ æ˜Ÿåº§ä¸äº”è¡Œ -->
    <div class="section" id="section-zodiac">
      <h2>ğŸŒŸ æ˜Ÿåº§ä¸äº”è¡Œ</h2>
      <div class="section-content">
        <p><strong>ä½ çš„æ˜Ÿåº§ï¼š</strong> <span id="zodiac">æœªçŸ¥</span></p>
        <p><strong>äº”è¡Œå±æ€§ï¼š</strong> <span id="element">æœªçŸ¥</span></p>
        <div class="tag-list" id="zodiac-tags"></div>
      </div>
    </div>

    <!-- ğŸª å››æ¶²è´¨å€¾å‘åˆ†å¸ƒ (æ¥è‡ª step1) -->
    <div class="section" id="section-temperament">
      <h2>ğŸª å››æ¶²è´¨å€¾å‘åˆ†å¸ƒ</h2>
      <div class="section-content">
        <div class="progress-item">
          <div class="progress-label"><strong>å¤šè¡€è´¨</strong> <span id="temperament-å¤šè¡€è´¨">7/10</span></div>
          <div class="progress-bar"><div class="progress-fill" id="fill-å¤šè¡€è´¨"></div></div>
        </div>
        <div class="progress-item">
          <div class="progress-label"><strong>èƒ†æ±è´¨</strong> <span id="temperament-èƒ†æ±è´¨">5/10</span></div>
          <div class="progress-bar"><div class="progress-fill" id="fill-èƒ†æ±è´¨"></div></div>
        </div>
        <div class="progress-item">
          <div class="progress-label"><strong>æŠ‘éƒè´¨</strong> <span id="temperament-æŠ‘éƒè´¨">4/10</span></div>
          <div class="progress-bar"><div class="progress-fill" id="fill-æŠ‘éƒè´¨"></div></div>
        </div>
        <div class="progress-item">
          <div class="progress-label"><strong>ç²˜æ¶²è´¨</strong> <span id="temperament-ç²˜æ¶²è´¨">6/10</span></div>
          <div class="progress-bar"><div class="progress-fill" id="fill-ç²˜æ¶²è´¨"></div></div>
        </div>
      </div>
    </div>

    <!-- ğŸ“Š åŸºç¡€äººæ ¼ç‰¹è´¨ -->
    <div class="section" id="section-self-bigfive">
      <h2>ğŸ“Š åŸºç¡€äººæ ¼ç‰¹è´¨</h2>
      <table><thead><tr><th>ç»´åº¦</th><th>å¾—åˆ†</th><th>æ»¡åˆ†</th><th>è§£è¯»</th></tr></thead>
        <tbody id="self-bigfive-body"></tbody>
      </table>
    </div>

    <!-- ğŸ¯ ç¯å¢ƒå½±å“äººæ ¼ç‰¹è´¨ -->
    <div class="section" id="section-env-bigfive">
      <h2>ğŸ¯ ç¯å¢ƒå½±å“äººæ ¼ç‰¹è´¨</h2>
      <table><thead><tr><th>ç»´åº¦</th><th>å¾—åˆ†</th><th>æ»¡åˆ†</th><th>è§£è¯»</th></tr></thead>
        <tbody id="env-bigfive-body"></tbody>
      </table>
    </div>

    <!-- ğŸ§­ äººæ ¼ç‰¹è´¨å¯¹æ¯” -->
    <div class="section" id="section-bigfive-radar">
      <h2>ğŸ§­ äººæ ¼ç‰¹è´¨å¯¹æ¯”</h2>
      <div class="chart-container"><canvas id="bigFiveRadar"></canvas></div>
    </div>

    <!-- âš–ï¸ æ°”è´¨å€¾å‘å¯¹æ¯” -->
    <div class="section" id="section-temperament-radar">
      <h2>âš–ï¸ æ°”è´¨å€¾å‘å¯¹æ¯”</h2>
      <div class="chart-container"><canvas id="temperamentRadar"></canvas></div>
    </div>

    <footer>
      <button class="btn-ghost" onclick="window.location.href='step2.html'">â¬… è¿”å›ä¸Šä¸€æ­¥</button>
      <button onclick="window.print()">ğŸ–¨ï¸ æ‰“å°/ä¿å­˜ä¸ºPDF</button>
    </footer>
  </div>

  <script>
    const errorBox = document.getElementById('errorBox');

    function showError(msg) {
      errorBox.innerHTML = `<div class="error">âš ï¸ ${msg}</div>`;
      document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
    }

    // 1. è¯»å–æ•°æ®
    let selfScores = null;
    let selectedTags = [];
    let zodiac = 'æœªçŸ¥';

    try {
      const rawScores = localStorage.getItem("selfScores");
      const rawTags = localStorage.getItem("selectedTags");

      if (!rawScores) throw new Error("æœªæ‰¾åˆ°è‡ªè¯„åˆ†æ•°ï¼Œè¯·å…ˆå®Œæˆ step1.html");
      if (!rawTags) throw new Error("æœªæ‰¾åˆ°è¡Œä¸ºæ ‡ç­¾ï¼Œè¯·å…ˆå®Œæˆ step2.html");

      selfScores = JSON.parse(rawScores);
      if (!Array.isArray(selfScores) || selfScores.length !== 5) {
        throw new Error("è‡ªè¯„åˆ†æ•°æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºé•¿åº¦ä¸º5çš„æ•°ç»„");
      }

      selectedTags = JSON.parse(rawTags);
      if (!Array.isArray(selectedTags)) {
        throw new Error("è¡Œä¸ºæ ‡ç­¾æ ¼å¼é”™è¯¯");
      }

      zodiac = localStorage.getItem("zodiac") || 'æœªçŸ¥';

    } catch (e) {
      console.error("æ•°æ®åŠ è½½å¤±è´¥:", e);
      showError(e.message);
      throw e;
    }

    // 2. æ˜¾ç¤ºæ˜Ÿåº§ä¿¡æ¯
    document.getElementById('zodiac').textContent = zodiac;

    const zodiacInfo = {
      "ç™½ç¾Šåº§": { element: "ç«", tags: ["å†’é™©è€…", "é¢†å¯¼è€…", "å†²åŠ¨è€…", "æˆ˜å£«", "å¼€æ‹“è€…"] },
      "é‡‘ç‰›åº§": { element: "åœŸ", tags: ["ä¿å®ˆè€…", "äº«å—è€…", "å›ºæ‰§è€…", "ç¨³å®šè€…", "ç¾é£Ÿå®¶"] },
      "åŒå­åº§": { element: "é£", tags: ["æ²Ÿé€šè€…", "å¥½å¥‡è€…", "å¤šå˜è€…", "ä¿¡æ¯è´©å­", "ç¤¾äº¤è¾¾äºº"] },
      "å·¨èŸ¹åº§": { element: "æ°´", tags: ["æƒ…æ„Ÿè€…", "ä¿æŠ¤è€…", "æ€€æ—§è€…", "å®¶åº­è‡³ä¸Š", "æ•æ„Ÿè€…"] },
      "ç‹®å­åº§": { element: "ç«", tags: ["è¡¨æ¼”è€…", "æ…·æ…¨è€…", "è‡ªæ‹è€…", "é¢†è¢–", "èšå…‰ç¯çˆ±å¥½è€…"] },
      "å¤„å¥³åº§": { element: "åœŸ", tags: ["å®Œç¾ä¸»ä¹‰è€…", "åˆ†æè€…", "æœåŠ¡è€…", "æŒ‘å‰”è€…", "ç§©åºæ§"] },
      "å¤©ç§¤åº§": { element: "é£", tags: ["å’Œå¹³è€…", "å®¡ç¾å®¶", "çŠ¹è±«è€…", "ç¤¾äº¤è´è¶", "å…³ç³»ç»´æŠ¤è€…"] },
      "å¤©èåº§": { element: "æ°´", tags: ["æ·±åˆ»è€…", "ç¥ç§˜è€…", "æŒæ§è€…", "å¤ä»‡è€…", "æ´å¯Ÿè€…"] },
      "å°„æ‰‹åº§": { element: "ç«", tags: ["å†’é™©å®¶", "è‡ªç”±è€…", "ä¹è§‚è€…", "æ—…è¡Œè€…", "å“²å­¦å®¶"] },
      "æ‘©ç¾¯åº§": { element: "åœŸ", tags: ["æ”€ç™»è€…", "ç°å®è€…", "è‡ªå¾‹è€…", "é‡å¿ƒå®¶", "å®ˆæ—§è€…"] },
      "æ°´ç“¶åº§": { element: "é£", tags: ["é©æ–°è€…", "æ€ªäºº", "ç†æƒ³ä¸»ä¹‰è€…", "åä¼ ç»Ÿ", "æœªæ¥ä¸»ä¹‰è€…"] },
      "åŒé±¼åº§": { element: "æ°´", tags: ["æ¢¦æƒ³å®¶", "åŒç†å¿ƒè€…", "é€ƒé¿è€…", "è‰ºæœ¯å®¶", "ç‰ºç‰²è€…"] }
    };

    const info = zodiacInfo[zodiac] || { element: "æœªçŸ¥", tags: ["æœªçŸ¥"] };
    document.getElementById('element').textContent = info.element;

    const tagList = document.getElementById('zodiac-tags');
    info.tags.forEach(tag => {
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = tag;
      tagList.appendChild(span);
    });

    // 3. ä» step1 çš„è‡ªè¯„æ¨æ–­å››æ¶²è´¨ (åŸºäºå¤§äº”äººæ ¼é¢˜ç›®)
    // ä½¿ç”¨ selfScores (0-100) ç›´æ¥æ˜ å°„
    const selfTemperament = {
      "å¤šè¡€è´¨": Math.round(selfScores[2] / 10), // å¤–å‘æ€§
      "èƒ†æ±è´¨": Math.round(selfScores[1] / 10), // å°½è´£æ€§
      "æŠ‘éƒè´¨": Math.round(selfScores[4] / 10), // ç¥ç»è´¨
      "ç²˜æ¶²è´¨": Math.round(selfScores[3] / 10)  // å®œäººæ€§
    };

    // 4. è®¡ç®—ç¯å¢ƒä¿®æ­£åçš„å››æ¶²è´¨åˆ†æ•° (æ¥è‡ª step2 çš„æ ‡ç­¾)
    const temperamentMap = {
      "å¤šè¡€è´¨": ["ç¤¾äº¤è¾¾äºº", "èˆæ± ç„¦ç‚¹", "æ®µå­æ‰‹", "èšä¼šå¸¸å®¢", "å¤œçŒ«å­ç¤¾äº¤", "æœ‹å‹åœˆå®½å¹¿", "å…¬ä¼—æ›å…‰", "è¡¨æ¼”è€…", "æƒ…ç»ªå‘æ³„", "è§†é¢‘åˆ›ä½œè€…", "æ¸¸æˆåœ¨çº¿", "ç›´æ’­ä¸»", "Kæ­Œè¾¾äºº", "è¯­éŸ³ç¤¾äº¤", "ç½‘ç»œæš§æ˜§", "è™šæ‹Ÿç¤¾äº¤", "éŸ³ä¹ç¤¾äº¤", "å¨±ä¹å‹ç¤¾äº¤", "é…’å±€ç¤¾äº¤", "è¿åŠ¨ç¤¾äº¤", "ç¾¤èŠä¸»å¯¼è€…", "ç»„ç»‡è€…", "åè°ƒè€…", "å†…å®¹åˆ›ä½œè€…", "äº§å“è¿è¥", "æ¸¸æˆç­–åˆ’", "äº§å“ç»ç†", "é”€å”®", "å¸‚åœº/å“ç‰Œ", "å…¬å…³", "å®¢æœ/è¿è¥", "åª’ä½“/å†…å®¹", "æ•™è‚²/åŸ¹è®­", "äº’è”ç½‘/è½¯ä»¶", "æ¸¸æˆ/å¨±ä¹", "ç”µå•†/é›¶å”®", "ç‰©æµ/ä¾›åº”é“¾", "æ—…æ¸¸/é…’åº—/é¤é¥®", "å†œä¸š/ç”Ÿç‰©ç§‘æŠ€"],
      "èƒ†æ±è´¨": ["åˆ›ä¸šå¤±è´¥", "é‡å¤§å¤±è´¥", "çªé‡è´µäºº", "å±æœºé¢†å¯¼", "ä¸­å¹´è½¬è¡Œ", "ä¼ä¸šå®¶/åˆ›å§‹äºº", "è‡ªç”±èŒä¸šè€…", "é”€å”®", "é¡¹ç›®ç»ç†", "æ³•åŠ¡", "è´¢åŠ¡/å®¡è®¡", "æˆ˜ç•¥/å’¨è¯¢", "æ•™å¸ˆ/è®²å¸ˆ", "åŒ»ç”Ÿ/æŠ¤å£«", "ç§‘ç ”äººå‘˜", "å†›äºº/è­¦å¯Ÿ", "æ”¿åºœ/äº‹ä¸šå•ä½", "å’¨è¯¢/æ³•å¾‹/ä¼šè®¡", "äººåŠ›/ç»„ç»‡", "åˆ¶é€ ä¸š/å·¥ä¸š", "æ±½è½¦/æ™ºèƒ½è½¦", "åŠå¯¼ä½“/ç¡¬ä»¶", "åŒ»ç–—/åŒ»è¯", "é‡‘è/æŠ•èµ„", "äº’è”ç½‘/è½¯ä»¶", "äººå·¥æ™ºèƒ½", "èƒ½æº/æ–°èƒ½æº", "æˆ¿åœ°äº§/å»ºç­‘", "å†›è­¦/å®‰é˜²"],
      "æŠ‘éƒè´¨": ["äº²å¯†å…³ç³»åˆ†æ‰‹", "ç¦»å©š", "ä¸§äº²ä¹‹ç—›", "é‡å¤§ç–¾ç—…", "åŸå¸‚è¿ç§»", "é•¿æœŸç…§æŠ¤äº²äºº", "é‡å¤§åˆä¼™åˆ†æ‰‹", "èƒŒå›/è¢«æ¬ºéª—", "å€ºåŠ¡å‹åŠ›", "è£å‘˜", "ç ´äº§", "å®ç°è´¢åŠ¡è‡ªç”±", "é«˜è€ƒ/å‡å­¦å¤±åˆ©", "é­é‡æ¬ºå‡Œ", "åˆ›ä¼¤åæˆé•¿", "é•¿é€”ç‹¬æ—…", "çµæ€§è§‰é†’", "ç§‘ç ”çªç ´", "ç«æŠ€å¤ºå† "],
      "ç²˜æ¶²è´¨": ["å¯’é—¨å‡ºèº«", "å·¥è–ªå®¶åº­", "åŸé•‡å®¶åº­", "å¿åŸåœŸè‘—", "ä¸­äº§å®¶åº­", "æ–°ä¸­äº§", "å‡†å¯Œè£•", "å¯Œè£•é˜¶å±‚", "è¶…é«˜å‡€å€¼", "å®¶æ—ä¼ä¸šèƒŒæ™¯", "ä½“åˆ¶å†…èƒŒæ™¯", "ç§»æ°‘å®¶åº­", "ç•™å­¦å®¶åº­", "å•äº²å®¶åº­", "ä¸å…‹/ä¸å©š", "å››ä¸–åŒå ‚", "åŸä¹¡æµåŠ¨", "å¤–æ¥åŠ¡å·¥", "èµ„æºç¨€ç¼ºåœ°åŒº", "æ•™è‚²èµ„æºå……æ²›", "çŸ¥è¯†ä»˜è´¹", "æç®€ä¸»ä¹‰", "ç¦æ¬²æ¶ˆè´¹", "åƒè´§", "å¥èº«æ¶ˆè´¹", "ç²¾ç¥æ¶ˆè´¹", "æ•°ç æ§", "å® ç‰©æ¶ˆè´¹", "æ±½è½¦æ§", "ç¾å¦†æ¶ˆè´¹", "å®¶å±…å¸ƒç½®", "å¨æˆ¿è¾¾äºº", "æ‘„å½±æ¶ˆè´¹", "æ•™è‚²æ¶ˆè´¹", "æ”¶è—ç™–", "æŠ•èµ„ç†è´¢", "æ—…æ¸¸æ¶ˆè´¹", "å¨±ä¹æ¶ˆè´¹", "å­¦ä¹ ä¸“æ³¨", "å†¥æƒ³æ—¶é—´", "æ•£æ­¥æ—¶é—´", "åˆ›ä½œæ—¶é—´", "å·¥ä½œç‹‚", "å‰¯ä¸šæ—¶é—´", "ç…§æŠ¤å®¶äºº", "ç¤¾ç¾¤ç»è¥", "é€šå‹¤æ—¶é—´é•¿", "æˆ·å¤–æ—¶é—´å¤š"]
    };

    const environmentTemperament = { "å¤šè¡€è´¨": 0, "èƒ†æ±è´¨": 0, "æŠ‘éƒè´¨": 0, "ç²˜æ¶²è´¨": 0 };
    let totalWeight = 0;

    selectedTags.forEach(tag => {
      const weight = tag.weight || 5;
      totalWeight += weight;
      for (const [type, labels] of Object.entries(temperamentMap)) {
        if (labels.includes(tag.label)) {
          environmentTemperament[type] += weight;
        }
      }
    });

    const normalizedEnvironmentTemperament = {};
    for (const type in environmentTemperament) {
      normalizedEnvironmentTemperament[type] = Math.round((environmentTemperament[type] / (totalWeight || 1)) * 10);
    }

    // 5. è®¡ç®—ç¯å¢ƒä¿®æ­£åçš„å¤§äº”äººæ ¼ (æ¥è‡ª step2 çš„æ ‡ç­¾)
    const bigFiveLabels = ["å¼€æ”¾æ€§", "å°½è´£æ€§", "å¤–å‘æ€§", "å®œäººæ€§", "ç¥ç»è´¨"];
    const environmentBigFive = [0, 0, 0, 0, 0];

    selectedTags.forEach(tag => {
      const weight = tag.weight || 5;
      // å¼€æ”¾æ€§
      if (["çµæ€§è§‰é†’", "é•¿é€”ç‹¬æ—…", "ç§‘ç ”çªç ´", "çŸ¥è¯†ä»˜è´¹", "æç®€ä¸»ä¹‰", "æ”¶è—ç™–", "åšå®¢ä½œè€…", "æŠ€æœ¯æå®¢", "AIæç¤ºå·¥ç¨‹", "æ’­å®¢å¬ä¼—", "çŸ­è§†é¢‘é‡åº¦"].includes(tag.label)) {
        environmentBigFive[0] += weight;
      }
      // å°½è´£æ€§
      if (["é«˜è€ƒ/å‡å­¦å¤±åˆ©", "é‡å¤§æ³•å¾‹çº çº·", "ä¸­å¹´è½¬è¡Œ", "é¡¹ç›®ç»ç†", "è´¢åŠ¡/å®¡è®¡", "æ³•åŠ¡", "é•¿æœŸè§„åˆ’è€…", "å¥èº«è§„å¾‹", "å·¥ä½œç‹‚", "æ•°æ®æ§", "æœºå™¨äººæ§", "æŠ•èµ„ç†è´¢"].includes(tag.label)) {
        environmentBigFive[1] += weight;
      }
      // å¤–å‘æ€§
      if (["ç¤¾äº¤è¾¾äºº", "ç¾¤èŠä¸»å¯¼è€…", "ç»„ç»‡è€…", "èˆå°æ§", "è§†é¢‘åˆ›ä½œè€…", "ç›´æ’­ä¸»", "æœ‹å‹åœˆåˆ·å±", "ç‚¹èµç‹‚é­”", "çƒ­ç‚¹è¿½éš", "æƒ…ç»ªå‘æ³„", "é¢‘ç¹åˆ†äº«", "Kæ­Œè¾¾äºº", "è¯­éŸ³ç¤¾äº¤", "æ¸¸æˆåœ¨çº¿", "èˆæ± ç„¦ç‚¹", "èšä¼šå¸¸å®¢"].includes(tag.label)) {
        environmentBigFive[2] += weight;
      }
      // å®œäººæ€§
      if (["å€¾å¬è€…", "åè°ƒè€…", "åœˆå­ç»´æŠ¤è€…", "å…¬ç›Šç¤¾äº¤", "é•¿æœŸç…§æŠ¤äº²äºº", "æƒ…æ„Ÿæ¶ˆè´¹", "å® ç‰©æ¶ˆè´¹", "å®¶åº­æ—¶é—´å¤š", "å®¢æœ/è¿è¥", "æ•™å¸ˆ/è®²å¸ˆ", "åŒ»ç”Ÿ/æŠ¤å£«"].includes(tag.label)) {
        environmentBigFive[3] += weight;
      }
      // ç¥ç»è´¨
      if (["é‡å¤§å¤±è´¥", "ç¦»å©š", "ä¸§äº²ä¹‹ç—›", "é‡å¤§ç–¾ç—…", "è£å‘˜", "ç ´äº§", "å€ºåŠ¡å‹åŠ›", "é­é‡æ¬ºå‡Œ", "èƒŒå›/è¢«æ¬ºéª—", "ä¿¡ç”¨æ¶ˆè´¹", "åˆ·å±æˆç˜¾", "æƒ…ç»ªå‘æ³„"].includes(tag.label)) {
        environmentBigFive[4] += weight;
      }
      // è´Ÿå‘æ ‡ç­¾ (é™ä½ç¥ç»è´¨)
      if (["å®ç°è´¢åŠ¡è‡ªç”±", "æ”¿ç­–çº¢åˆ©", "å†¥æƒ³æ—¶é—´", "æ•£æ­¥æ—¶é—´", "æç®€ä¸»ä¹‰", "æŠ•èµ„ç†è´¢"].includes(tag.label)) {
        environmentBigFive[4] -= weight;
      }
    });

    // å½’ä¸€åŒ–åˆ° 0-100
    const totalWeightBigFive = selectedTags.reduce((sum, tag) => sum + (tag.weight || 5), 0);
    const normalizedEnvironmentBigFive = environmentBigFive.map(v => {
      return Math.round((v / (totalWeightBigFive || 1)) * 100);
    });

    // 6. æ›´æ–°å››æ¶²è´¨æ¡å½¢å›¾ (æ¥è‡ª step1)
    Object.keys(selfTemperament).forEach(type => {
      const score = selfTemperament[type];
      document.getElementById(`temperament-${type}`).textContent = `${score}/10`;
      document.getElementById(`fill-${type}`).style.width = `${score * 10}%`;
    });

    // 7. æ›´æ–°è¡¨æ ¼
    function updateTable(tableId, scores) {
      const tbody = document.getElementById(tableId);
      tbody.innerHTML = bigFiveLabels.map((label, i) => `
        <tr>
          <td>${label}</td>
          <td class="score">${scores[i]}</td>
          <td>100</td>
          <td class="interpretation">
            ${i === 4 ? (scores[i] < 40 ? '<span class="highlight">éå¸¸ç¨³å®š</span>ï¼Œä¸æ˜“ç„¦è™‘' : 'æƒ…ç»ªè¾ƒæ•æ„Ÿ') :
              i === 0 ? (scores[i] > 70 ? '<span class="highlight">é«˜åº¦å¼€æ”¾</span>ï¼Œæ€ç»´æ´»è·ƒ' : 'åå¥½ç†Ÿæ‚‰çš„äº‹ç‰©') :
              i === 1 ? (scores[i] > 70 ? '<span class="highlight">é«˜åº¦è‡ªå¾‹</span>ï¼Œæœ‰æ¡ç†' : 'æœ‰æ—¶ä¼šæ‹–å»¶') :
              i === 2 ? 'å†…å¤–å‘å¹³è¡¡' :
              'æœ‰è‡ªå·±çš„ä¸»è§'}
          </td>
        </tr>
      `).join('');
    }

    updateTable('self-bigfive-body', selfScores);
    updateTable('env-bigfive-body', normalizedEnvironmentBigFive);

    // 8. æ¸²æŸ“å›¾è¡¨
    function renderCharts() {
      const bigFiveRadarCtx = document.getElementById('bigFiveRadar').getContext('2d');
      new Chart(bigFiveRadarCtx, {
        type: 'radar',
         {
          labels: bigFiveLabels,
          datasets: [
            {
              label: 'åŸºç¡€ç‰¹è´¨',
               selfScores,
              borderColor: '#4dabf7',
              backgroundColor: 'rgba(77, 171, 247, 0.1)',
              pointBackgroundColor: '#4dabf7',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#4dabf7',
              fill: true
            },
            {
              label: 'ç¯å¢ƒå½±å“',
               normalizedEnvironmentBigFive,
              borderColor: '#66b3ff',
              backgroundColor: 'rgba(102, 179, 255, 0.1)',
              pointBackgroundColor: '#66b3ff',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#66b3ff',
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              angleLines: { display: true, color: '#e0e0e0' },
              grid: { circular: true, color: '#e0e0e0' },
              ticks: { display: true, color: '#666' }
            }
          },
          plugins: { legend: { position: 'top' } }
        }
      });

      const temperamentRadarCtx = document.getElementById('temperamentRadar').getContext('2d');
      new Chart(temperamentRadarCtx, {
        type: 'radar',
         {
          labels: ['å¤šè¡€è´¨', 'èƒ†æ±è´¨', 'æŠ‘éƒè´¨', 'ç²˜æ¶²è´¨'],
          datasets: [
            {
              label: 'åŸºç¡€å€¾å‘',
               Object.values(selfTemperament),
              borderColor: '#4dabf7',
              backgroundColor: 'rgba(77, 171, 247, 0.1)',
              pointBackgroundColor: '#4dabf7',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#4dabf7',
              fill: true
            },
            {
              label: 'ç¯å¢ƒå½±å“',
               Object.values(normalizedEnvironmentTemperament),
              borderColor: '#66b3ff',
              backgroundColor: 'rgba(102, 179, 255, 0.1)',
              pointBackgroundColor: '#66b3ff',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#66b3ff',
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              angleLines: { display: true, color: '#e0e0e0' },
              grid: { circular: true, color: '#e0e0e0' },
              ticks: { display: true, color: '#666' }
            }
          },
          plugins: { legend: { position: 'top' } }
        }
      });
    }

    // 9. é¡µé¢åŠ è½½å®Œæˆåæ¸²æŸ“
    document.addEventListener('DOMContentLoaded', () => {
      try {
        renderCharts();
      } catch (e) {
        console.error("å›¾è¡¨æ¸²æŸ“å¤±è´¥:", e);
        showError("å›¾è¡¨æ¸²æŸ“å¤±è´¥ï¼š" + e.message);
      }
    });
  </script>
</body>
</html>