<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ–°é›¶å”®å•†åŸ Demoï¼ˆå†…å®¹+äº¤æ˜“+å¯¼æµ+ä¼šå‘˜ï¼‰</title>
<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --ink:#1f2937; --muted:#6b7280;
    --brand:#4f46e5; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --line:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"Noto Sans SC",Helvetica,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  .app{max-width:1100px;margin:0 auto;padding:12px 12px 96px}
  header.top{position:sticky;top:0;background:rgba(247,248,251,.9);backdrop-filter:blur(6px);z-index:20;border-bottom:1px solid var(--line)}
  .topbar{display:flex;align-items:center;gap:12px;padding:12px}
  .logo{font-weight:800;letter-spacing:.5px}
  .pill{padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
  nav.tabs{display:flex;gap:6px;flex-wrap:wrap;padding:0 12px 12px}
  nav.tabs button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  nav.tabs button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:860px){.row{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 10px 20px rgba(0,0,0,.03)}
  .section-title{font-weight:700;margin:6px 0 10px}
  .hero{display:grid;grid-template-columns:1.4fr 1fr;gap:12px}
  @media (max-width:860px){.hero{grid-template-columns:1fr}}
  .carousel{position:relative;height:220px;border-radius:12px;overflow:hidden;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;font-size:28px}
  .carousel .dotbox{position:absolute;bottom:10px;display:flex;gap:6px}
  .carousel .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.5)}
  .carousel .dot.on{background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;cursor:pointer}
  .chip.on{background:#111;color:#fff;border-color:#111}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:780px){.grid{grid-template-columns:repeat(2,1fr)}}
  .prod{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px;display:flex;flex-direction:column}
  .thumb{height:120px;border-radius:8px;background:linear-gradient(135deg,#e9efff,#d1fae5);display:flex;align-items:center;justify-content:center;font-size:40px}
  .price{font-weight:800}
  .muted{color:var(--muted);font-size:12px}
  .btn{appearance:none;border:1px solid var(--brand);color:#fff;background:var(--brand);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--brand)}
  .btn.warn{background:var(--warn);border-color:var(--warn)}
  .btn.ok{background:var(--ok);border-color:var(--ok)}
  .btn.bad{background:var(--bad);border-color:var(--bad)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  @media (max-width:780px){.kpi{grid-template-columns:repeat(2,1fr)}}
  .kpi .box{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;text-align:center}
  .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.25s;z-index:99}
  .toast.show{opacity:1;transform:none}
  .drawer{position:fixed;right:16px;top:80px;width:320px;max-height:70vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.15);padding:12px;display:none;z-index:50}
  .drawer.show{display:block}
  .line{height:1px;background:var(--line);margin:10px 0}
  .flex{display:flex;align-items:center;gap:8px}
  .space{flex:1}
  footer.bar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);padding:8px 12px;display:flex;gap:8px;align-items:center;z-index:30}
  .badge{font-size:11px;padding:2px 6px;border-radius:6px;background:#eef2ff;color:#3730a3}
  .progress{height:8px;background:#eef2ff;border-radius:999px;overflow:hidden}
  .progress > i{display:block;height:100%;background:var(--brand)}
  .timeline{border-left:2px solid var(--line);padding-left:10px;margin-left:6px}
  .timeline div{margin:8px 0}
  .log{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1020;color:#d1e8ff;border-radius:10px;padding:10px;font-size:12px;white-space:pre-wrap}
</style>
</head>
<body>
<header class="top">
  <div class="topbar">
    <div class="logo">ğŸ›ï¸ æ–°é›¶å”®å•†åŸ Demo</div>
    <span class="pill">æ ¸å¿ƒè·¯å¾„ï¼šå•†åŸè´­ç‰© +ï¼ˆæ–‡åŒ– or å¯¼æµï¼‰</span>
    <div class="space"></div>
    <button class="btn ghost" id="btnCart">è´­ç‰©è½¦ <span id="cartCount" class="badge">0</span></button>
    <button class="btn ghost" id="btnLogs">åŸ‹ç‚¹æ—¥å¿—</button>
  </div>
  <nav class="tabs" id="tabs"></nav>
</header>

<div class="app" id="app"></div>

<!-- æŠ½å±‰ï¼šè´­ç‰©è½¦ / æ—¥å¿— -->
<div class="drawer" id="drawerCart"></div>
<div class="drawer" id="drawerLogs"></div>

<footer class="bar">
  <div class="flex"><b>æ¨¡å¼ï¼š</b>
    <button class="chip" id="modeCulture">æ–‡åŒ–ä¼˜å…ˆ</button>
    <button class="chip" id="modeDirect">å¯¼æµä¼˜å…ˆ</button>
  </div>
  <div class="space"></div>
  <div class="muted">æœ¬ Demo ä»…ä¸ºä½“éªŒç”¨ï¼Œæ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ã€‚</div>
</footer>

<div class="toast" id="toast"></div>

<script>
/* ------------------------- æ•°æ®ä¸çŠ¶æ€ ------------------------- */
const LS_KEY = "mall_demo_state_v1";
const defaultData = {
  mode:"culture", // culture / direct
  cart:{items:[], couponId:null},
  coupons:[
    {id:"C200-20", title:"æ»¡200å‡20", type:"cash", threshold:200, value:20, acquired:false, used:false},
    {id:"C400-50", title:"æ»¡400å‡50", type:"cash", threshold:400, value:50, acquired:false, used:false},
    {id:"OFF-COFFEE", title:"çº¿ä¸‹å’–å•¡åˆ¸", type:"offline", threshold:0, value:1, code:"COFFEE-2025", acquired:false, used:false}
  ],
  products:[
    {id:"A101", name:"æ‰‹å·¥æœ¨è´¨æ‰˜ç›˜", price:129, rating:4.7, cat:"å®¶å±…", icon:"ğŸªµ", tags:["å¤©ç„¶","æ‰‹ä½œ"]},
    {id:"A102", name:"åŒ—æ¬§é¦™è–°èœ¡çƒ›", price:89, rating:4.5, cat:"å®¶å±…", icon:"ğŸ•¯ï¸", tags:["é¦™æ°›","æ²»æ„ˆ"]},
    {id:"B201", name:"åŸåˆ›ç‰ˆç”»Â·æµ·é£", price:399, rating:4.9, cat:"è‰ºæœ¯", icon:"ğŸ–¼ï¸", tags:["é™é‡","åŸåˆ›"]},
    {id:"B202", name:"æ‰‹ä½œé™¶æ¯", price:159, rating:4.6, cat:"è‰ºæœ¯", icon:"ğŸº", tags:["åŒ å¿ƒ"]},
    {id:"C301", name:"æŒ‚è€³å’–å•¡ 12åŒ…", price:98, rating:4.4, cat:"å’–å•¡", icon:"â˜•", tags:["æ‹¼é…","æ¸…çˆ½"]},
    {id:"C302", name:"å†·èƒç“¶ 600ml", price:69, rating:4.2, cat:"å’–å•¡", icon:"ğŸ§Š", tags:["å¤æ—¥"]},
    {id:"D401", name:"è“ç‰™éŸ³ç®± mini", price:299, rating:4.5, cat:"æ•°ç ", icon:"ğŸ“»", tags:["ä¾¿æº"]},
    {id:"D402", name:"é˜…è¯»å°ç¯", price:189, rating:4.3, cat:"æ•°ç ", icon:"ğŸ’¡", tags:["æŠ¤çœ¼"]}
  ],
  cases:[
    {id:"S1", title:"ä¸€åªæ‰˜ç›˜çš„æ—…è¡Œ", cover:"ğŸªµ", brief:"ä»åºŸæœ¨åˆ°é¤æ¡Œçš„äºŒæ¬¡ç”Ÿå‘½", link:"A101"},
    {id:"S2", title:"ç”»é‡Œçš„é£", cover:"ğŸ–¼ï¸", brief:"åŸåˆ›ç‰ˆç”»èƒŒåçš„åˆ›ä½œæ‰‹è®°", link:"B201"}
  ],
  orders:[],
  user:{name:"æ¸¸å®¢", points:0, address:"", level:"æ™®é€š"},
  logs:[]
};
let state = loadState();

/* ------------------------- å·¥å…·å‡½æ•° ------------------------- */
function $(sel,root=document){ return root.querySelector(sel); }
function $all(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || structuredClone(defaultData);}catch(e){return structuredClone(defaultData)}}
function money(n){ return "Â¥"+n.toFixed(2); }
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1600); }
function track(event, payload={}){ const row={t:new Date().toLocaleString(),event,payload}; state.logs.unshift(row); saveState(); console.log("[track]",row); renderCartCount(); }

/* ------------------------- è·¯ç”±ä¸é¡µé¢ ------------------------- */
const PAGES = [
  {id:"home", label:"é¦–é¡µ"},
  {id:"shop", label:"å•†åŸ"},
  {id:"scan", label:"æ‰«ç ç›´è¾¾"},
  {id:"cases", label:"æ¡ˆä¾‹/æ–‡åŒ–"},
  {id:"coupon", label:"ä¼˜æƒ åˆ¸"},
  {id:"me", label:"ä¸ªäººä¸­å¿ƒ"}
];
let current="home";

function renderNav(){
  const nav=$("#tabs");
  nav.innerHTML = PAGES.map(p=>`<button data-id="${p.id}" class="${p.id===current?'active':''}">${p.label}</button>`).join("");
  $all("button", nav).forEach(b=>b.onclick=()=>{ current=b.dataset.id; render(); track("tab_switch",{to:current}); });
}
function render(){ renderNav(); const el=$("#app"); el.innerHTML="";
  if(current==="home") renderHome(el);
  if(current==="shop") renderShop(el);
  if(current==="scan") renderScan(el);
  if(current==="cases") renderCases(el);
  if(current==="coupon") renderCoupon(el);
  if(current==="me") renderMe(el);
  renderCartCount();
}

/* ------------------------- é¦–é¡µ ------------------------- */
function renderHome(root){
  const wrap=document.createElement("div");
  // hero
  const hero=document.createElement("div"); hero.className="hero";
  hero.innerHTML=`
    <div class="card">
      <div class="carousel" id="carousel">
        <div>æ–°å“ä¸Šæ¶ Â· å¤æ—¥ç‰¹è¾‘</div>
        <div class="dotbox">
          <span class="dot on"></span><span class="dot"></span><span class="dot"></span>
        </div>
      </div>
      <div class="line"></div>
      <div class="toolbar">
        <b>å¿«é€Ÿå…¥å£</b>
        <button class="btn" onclick="goto('shop')">å»é€›å•†åŸ</button>
        <button class="btn warn" onclick="goto('coupon')">é¢†ä¼˜æƒ åˆ¸</button>
        <button class="btn ghost" onclick="goto('scan')">æ‰«ç ç›´è¾¾</button>
      </div>
    </div>
    <div class="card">
      <div class="section-title">é¦–é¡µå¸ƒå±€æ¨¡å¼</div>
      <div class="chips">
        <span class="chip ${state.mode==='culture'?'on':''}" onclick="setMode('culture')">æ–‡åŒ–ä¼˜å…ˆ</span>
        <span class="chip ${state.mode==='direct'?'on':''}" onclick="setMode('direct')">å¯¼æµä¼˜å…ˆ</span>
      </div>
      <div class="line"></div>
      <div class="muted">è¯´æ˜ï¼šæ ¹æ®å®šä½é€‰æ‹©é¦–é¡µé‡ç‚¹ã€‚æ–‡åŒ–ä¼˜å…ˆ â†’ çªå‡ºæ¡ˆä¾‹æ•…äº‹ï¼›å¯¼æµä¼˜å…ˆ â†’ çªå‡ºä¼˜æƒ åˆ¸ä¸æ‰«ç å…¥å£ã€‚</div>
    </div>`;
  wrap.appendChild(hero);

  // ä¸¤åˆ—åŒºå—ï¼šæ ¹æ®æ¨¡å¼åˆ‡æ¢é¡ºåº
  const A = `
    <div class="card">
      <div class="section-title">ç²¾é€‰å¯„å”®æ¡ˆä¾‹</div>
      <div class="grid">
        ${state.cases.map(s=>`
          <div class="prod">
            <div class="thumb">${s.cover}</div>
            <b>${s.title}</b>
            <div class="muted">${s.brief}</div>
            <div class="space"></div>
            <button class="btn ghost" onclick="openCase('${s.id}')">é˜…è¯»æ•…äº‹</button>
          </div>`).join("")}
      </div>
    </div>`;
  const B = `
    <div class="card">
      <div class="section-title">çƒ­é—¨å•†å“</div>
      <div class="grid">
        ${state.products.slice(0,4).map(p=>prodCard(p)).join("")}
      </div>
    </div>`;
  const C = `
    <div class="card">
      <div class="section-title">ä¼˜æƒ ä¸å¯¼æµ</div>
      <div class="kpi">
        <div class="box"><b>ä¼˜æƒ åˆ¸</b><div class="muted">æ»¡å‡åˆ¸/çº¿ä¸‹åˆ¸</div><div class="line"></div><button class="btn" onclick="goto('coupon')">ç«‹å³é¢†å–</button></div>
        <div class="box"><b>æ‰«ç è´­</b><div class="muted">çº¿ä¸‹å•†å“äºŒç»´ç ç›´è¾¾</div><div class="line"></div><button class="btn ghost" onclick="goto('scan')">å»æ‰«ç </button></div>
        <div class="box"><b>ç›´æ’­</b><div class="muted">ï¼ˆå ä½ï¼ŒåæœŸæ¥å…¥ï¼‰</div><div class="line"></div><button class="btn" disabled>æ•¬è¯·æœŸå¾…</button></div>
        <div class="box"><b>é¢„çº¦</b><div class="muted">ï¼ˆå ä½ï¼ŒåæœŸæ¥å…¥ï¼‰</div><div class="line"></div><button class="btn" disabled>æ•¬è¯·æœŸå¾…</button></div>
      </div>
    </div>`;

  const row=document.createElement("div"); row.className="row";
  if(state.mode==="culture"){ row.innerHTML=A + B; wrap.appendChild(row); wrap.insertAdjacentHTML("beforeend", C); }
  else{ row.innerHTML=B + C; wrap.appendChild(row); wrap.insertAdjacentHTML("beforeend", A); }

  root.appendChild(wrap);
  // ç®€æ˜“è½®æ’­
  let idx=0; setInterval(()=>{ const dots=$all(".carousel .dot"); dots.forEach(d=>d.classList.remove("on")); idx=(idx+1)%dots.length; dots[idx].classList.add("on"); }, 2500);
}
function setMode(m){ state.mode=m; saveState(); toast(m==="culture"?"å·²åˆ‡æ¢ä¸ºï¼šæ–‡åŒ–ä¼˜å…ˆ":"å·²åˆ‡æ¢ä¸ºï¼šå¯¼æµä¼˜å…ˆ"); render(); track("mode_switch",{mode:m}); }
function goto(id){ current=id; render(); }

/* ------------------------- å•†åŸ ------------------------- */
function renderShop(root){
  const cats=[...new Set(state.products.map(p=>p.cat))];
  let q=""; let cat="å…¨éƒ¨"; let sort="ç»¼åˆ";
  const card=document.createElement("div"); card.className="card";
  card.innerHTML=`
    <div class="section-title">å•†åŸ</div>
    <div class="toolbar">
      <input id="q" placeholder="æœç´¢å•†å“å…³é”®å­—â€¦" />
      <select id="cat">${["å…¨éƒ¨",...cats].map(c=>`<option>${c}</option>`).join("")}</select>
      <select id="sort">
        <option>ç»¼åˆ</option><option>ä»·æ ¼â¬†</option><option>ä»·æ ¼â¬‡</option><option>è¯„åˆ†â¬†</option>
      </select>
      <div class="space"></div>
      <button class="btn" onclick="openCart()">æŸ¥çœ‹è´­ç‰©è½¦</button>
    </div>
    <div id="grid" class="grid" style="margin-top:12px"></div>`;
  root.appendChild(card);

  const grid=$("#grid",card);
  function apply(){
    let list=[...state.products];
    if(cat!=="å…¨éƒ¨") list=list.filter(p=>p.cat===cat);
    if(q.trim()) list=list.filter(p=>p.name.includes(q) || (p.tags||[]).some(t=>t.includes(q)));
    if(sort==="ä»·æ ¼â¬†") list.sort((a,b)=>a.price-b.price);
    if(sort==="ä»·æ ¼â¬‡") list.sort((a,b)=>b.price-a.price);
    if(sort==="è¯„åˆ†â¬†") list.sort((a,b)=>b.rating-a.rating);
    grid.innerHTML=list.map(p=>prodCard(p)).join("");
  }
  $("#q",card).oninput=e=>{q=e.target.value;apply()};
  $("#cat",card).onchange=e=>{cat=e.target.value;apply()};
  $("#sort",card).onchange=e=>{sort=e.target.value;apply()};
  apply();
}
function prodCard(p){
  return `
  <div class="prod">
    <div class="thumb">${p.icon}</div>
    <b>${p.name}</b>
    <div class="muted">ç±»åˆ«ï¼š${p.cat} Â· è¯„åˆ† ${p.rating}</div>
    <div class="space"></div>
    <div class="flex">
      <div class="price">${money(p.price)}</div><div class="space"></div>
      <button class="btn ghost" onclick="openDetail('${p.id}')">è¯¦æƒ…</button>
      <button class="btn" onclick="addToCart('${p.id}')">åŠ å…¥</button>
    </div>
  </div>`;
}
function openDetail(id){
  const p=state.products.find(x=>x.id===id);
  const code="PROD-"+p.id;
  const html=`
    <div class="card">
      <div class="section-title">${p.name}</div>
      <div class="row">
        <div class="card"><div class="thumb" style="height:180px;font-size:60px">${p.icon}</div></div>
        <div class="card">
          <div><b>ä»·æ ¼ï¼š</b>${money(p.price)}</div>
          <div><b>è¯„åˆ†ï¼š</b>${p.rating}</div>
          <div><b>æ ‡ç­¾ï¼š</b>${(p.tags||[]).join(" / ")||"æ— "}</div>
          <div class="line"></div>
          <div class="muted">äºŒç»´ç å­—ç¬¦ä¸²ï¼ˆç”¨äºæ‰«ç ç›´è¾¾ï¼‰ï¼š<br><b>${code}</b></div>
          <div class="line"></div>
          <div class="flex">
            <button class="btn" onclick="addToCart('${p.id}')">åŠ å…¥è´­ç‰©è½¦</button>
            <button class="btn ghost" onclick="closeCart();">å…³é—­</button>
          </div>
        </div>
      </div>
    </div>`;
  $("#drawerCart").innerHTML=html; $("#drawerCart").classList.add("show");
  track("view_detail",{id});
}

/* ------------------------- æ‰«ç ç›´è¾¾ ------------------------- */
function renderScan(root){
  const card=document.createElement("div"); card.className="card";
  card.innerHTML=`
    <div class="section-title">æ‰«ç ç›´è¾¾</div>
    <div class="toolbar">
      <input id="scanInput" placeholder="è¯·è¾“å…¥äºŒç»´ç å­—ç¬¦ä¸²ï¼Œå¦‚ï¼šPROD-A101" style="flex:1" />
      <button class="btn" id="btnScan">æ¨¡æ‹Ÿæ‰«ç </button>
    </div>
    <div class="muted" style="margin-top:8px">æç¤ºï¼šåœ¨å•†å“è¯¦æƒ…é¡µå¯æŸ¥çœ‹å„è‡ªçš„äºŒç»´ç å­—ç¬¦ä¸²ã€‚</div>
    <div id="scanResult" style="margin-top:12px"></div>`;
  root.appendChild(card);

  $("#btnScan",card).onclick=()=>{
    const v=$("#scanInput",card).value.trim();
    const id=(v.split("PROD-")[1]||"").toUpperCase();
    const p=state.products.find(x=>x.id===id);
    const box=$("#scanResult",card);
    if(!p){ box.innerHTML=`<div class="card">æœªæ‰¾åˆ°å•†å“ï¼Œæ£€æŸ¥äºŒç»´ç å­—ç¬¦ä¸²æ˜¯å¦æ­£ç¡®ã€‚</div>`; track("scan_fail",{v}); return;}
    box.innerHTML = `<div class="card">${prodCard(p)}</div>`;
    track("scan_ok",{id});
  };
}

/* ------------------------- æ¡ˆä¾‹/æ–‡åŒ– ------------------------- */
function renderCases(root){
  const card=document.createElement("div"); card.className="card";
  card.innerHTML=`
    <div class="section-title">å¯„å”®æ¡ˆä¾‹/æ–‡åŒ–æ•…äº‹</div>
    <div class="grid">${state.cases.map(s=>`
      <div class="prod">
        <div class="thumb" style="height:120px;font-size:40px">${s.cover}</div>
        <b>${s.title}</b>
        <div class="muted">${s.brief}</div>
        <div class="space"></div>
        <button class="btn" onclick="openCase('${s.id}')">é˜…è¯»</button>
      </div>`).join("")}</div>`;
  root.appendChild(card);
}
function openCase(id){
  const s=state.cases.find(x=>x.id===id);
  const p=state.products.find(x=>x.id===s.link);
  const html=`
    <div class="card">
      <div class="section-title">ğŸ“ ${s.title}</div>
      <p class="muted">ï¼ˆçŸ­æ–‡ç¤ºä¾‹ï¼‰${s.brief}ã€‚æˆ‘ä»¬ä¸ä½œè€…æ²Ÿé€šï¼Œå°†ä½œå“ä¸ç”Ÿæ´»ç©ºé—´ç»“åˆâ€¦â€¦</p>
      <div class="line"></div>
      <div><b>æ–‡ä¸­æåˆ°çš„å•†å“ï¼š</b></div>
      <div style="margin-top:8px">${prodCard(p)}</div>
    </div>`;
  $("#drawerCart").innerHTML=html; $("#drawerCart").classList.add("show");
  track("open_case",{id});
}

/* ------------------------- ä¼˜æƒ åˆ¸ & æ ¸é”€ ------------------------- */
function renderCoupon(root){
  const wrap=document.createElement("div"); wrap.className="row";
  const list=document.createElement("div"); list.className="card";
  list.innerHTML=`<div class="section-title">å¯é¢†å–çš„ä¼˜æƒ åˆ¸</div>
    <div class="grid">
      ${state.coupons.map(c=>`
        <div class="prod">
          <div class="thumb" style="font-size:34px;background:linear-gradient(135deg,#fff7ed,#fee2e2)">${c.type==='offline'?'ğŸ·ï¸':'ğŸ’¸'}</div>
          <b>${c.title}</b>
          <div class="muted">${c.type==='offline'?'çº¿ä¸‹é—¨åº—æ‰«ç æ ¸é”€':'ä¸‹å•è‡ªåŠ¨ä½¿ç”¨ï¼ˆæ»¡è¶³é—¨æ§›å¯é€‰ç”¨ï¼‰'}</div>
          ${c.type==='offline'?`<div class="muted">æ ¸é”€ç ï¼š<b>${c.code}</b></div>`:""}
          <div class="space"></div>
          ${c.acquired?`<span class="badge">å·²é¢†å–</span>`:`<button class="btn" onclick="claimCoupon('${c.id}')">é¢†å–</button>`}
        </div>`).join("")}
    </div>`;
  wrap.appendChild(list);

  const verify=document.createElement("div"); verify.className="card";
  verify.innerHTML=`
    <div class="section-title">æ ¸é”€å°ï¼ˆåº—å‘˜ï¼‰</div>
    <div class="toolbar">
      <input id="verifyCode" placeholder="è¾“å…¥æ ¸é”€ç ï¼ˆå¦‚ï¼šCOFFEE-2025ï¼‰" style="flex:1"/>
      <button class="btn ok" id="doVerify">æ ¸é”€</button>
    </div>
    <div id="verifyResult" style="margin-top:10px"></div>
    <div class="line"></div>
    <div class="muted">è¯´æ˜ï¼šä»… <b>çº¿ä¸‹åˆ¸</b> å¯åœ¨æ­¤æ ¸é”€ï¼›çº¿ä¸Šæ»¡å‡åˆ¸åœ¨ç»“ç®—æ—¶ä½¿ç”¨ã€‚</div>`;
  verify.querySelector("#doVerify").onclick=()=>{
    const code=verify.querySelector("#verifyCode").value.trim();
    const c=state.coupons.find(x=>x.type==='offline' && x.code===code);
    const box=verify.querySelector("#verifyResult");
    if(!c){ box.innerHTML=`<div class="muted">æœªæ‰¾åˆ°å¯¹åº”çš„çº¿ä¸‹åˆ¸æˆ–åˆ¸ç é”™è¯¯ã€‚</div>`; track("verify_fail",{code}); return;}
    if(!c.acquired){ box.innerHTML=`<div class="muted">ç”¨æˆ·å°šæœªé¢†å–æ­¤åˆ¸ï¼Œæ— æ³•æ ¸é”€ã€‚</div>`; return;}
    if(c.used){ box.innerHTML=`<div class="muted">è¯¥åˆ¸å·²ä½¿ç”¨ã€‚</div>`; return;}
    c.used=true; saveState(); box.innerHTML=`<div class="muted">âœ… å·²æ ¸é”€ï¼š${c.title}</div>`; track("verify_ok",{id:c.id}); toast("æ ¸é”€æˆåŠŸ");
  };
  wrap.appendChild(verify);
  root.appendChild(wrap);
}
function claimCoupon(id){
  const c=state.coupons.find(x=>x.id===id); c.acquired=true; saveState(); render(); toast("å·²é¢†å–ï¼š"+c.title); track("coupon_claim",{id});
}

/* ------------------------- ä¸ªäººä¸­å¿ƒ ------------------------- */
function renderMe(root){
  const u=state.user;
  const card=document.createElement("div"); card.className="card";
  const percent = Math.min(100, (u.points%3000)/30); // åªæ˜¯å±•ç¤º
  const orders = state.orders.slice(0,20);
  card.innerHTML=`
    <div class="section-title">ä¸ªäººä¸­å¿ƒ</div>
    <div class="row">
      <div class="card">
        <b>ä¼šå‘˜ç­‰çº§ï¼š</b> ${getLevel().level}
        <div class="muted">ç§¯åˆ†ï¼š${u.points}ï¼ˆä¸‹å•é€ç§¯åˆ†ï¼Œå¯è§£é”æ›´é«˜ç­‰çº§ï¼‰</div>
        <div class="progress" style="margin:8px 0"><i style="width:${percent}%"></i></div>
        <div class="line"></div>
        <div><b>æ”¶è´§åœ°å€</b></div>
        <div class="flex" style="margin-top:6px">
          <input id="addr" value="${u.address||''}" placeholder="çœå¸‚åŒº + è¯¦ç»†åœ°å€" style="flex:1"/>
          <button class="btn" onclick="saveAddr()">ä¿å­˜</button>
        </div>
      </div>
      <div class="card">
        <b>æˆ‘çš„è®¢å•</b>
        ${orders.length? orders.map(o=>orderCard(o)).join("") : '<div class="muted" style="margin-top:6px">æš‚æ— è®¢å•</div>'}
      </div>
    </div>`;
  root.appendChild(card);
}
function orderCard(o){
  return `
  <div class="card" style="margin-top:8px">
    <div class="flex"><b>è®¢å• ${o.id}</b><div class="space"></div><span class="badge">${o.status}</span></div>
    <div class="muted">é‡‘é¢ï¼š${money(o.pay)}ï¼Œæ”¯ä»˜ï¼š${o.channel}</div>
    <div class="muted">å•†å“ï¼š${o.items.map(i=>i.id+"Ã—"+i.qty).join("ï¼Œ")}</div>
    <div class="line"></div>
    <button class="btn ghost" onclick="showLogistics('${o.id}')">æŸ¥çœ‹ç‰©æµ</button>
  </div>`;
}
function showLogistics(oid){
  const o=state.orders.find(x=>x.id===oid);
  const html=`
    <div class="card">
      <div class="section-title">ç‰©æµè·Ÿè¸ª</div>
      <div class="timeline">${o.logistics.map(x=>`<div><b>${x.time}</b> - ${x.desc}</div>`).join("")}</div>
      <div class="line"></div>
      <button class="btn ghost" onclick="closeCart()">å…³é—­</button>
    </div>`;
  $("#drawerCart").innerHTML=html; $("#drawerCart").classList.add("show");
}
function saveAddr(){ state.user.address=$("#addr").value.trim(); saveState(); toast("å·²ä¿å­˜åœ°å€"); track("addr_save"); }
function getLevel(){
  const pts=state.user.points;
  if(pts>=7000) return {level:"VIP", mult:1.2};
  if(pts>=3000) return {level:"é‡‘å¡", mult:1.1};
  if(pts>=1000) return {level:"é“¶å¡", mult:1.05};
  return {level:"æ™®é€š", mult:1};
}

/* ------------------------- è´­ç‰©è½¦ & ç»“ç®— ------------------------- */
function renderCartCount(){
  const count = state.cart.items.reduce((s,i)=>s+i.qty,0);
  $("#cartCount").textContent = count;
}
function openCart(){
  const box=$("#drawerCart"); box.classList.add("show");
  const items = state.cart.items.map(ci=>{
    const p=state.products.find(x=>x.id===ci.id);
    return `<div class="flex"><span>${p.name}</span><div class="space"></div>
      <button class="btn ghost" onclick="dec('${ci.id}')">ï¼</button>
      <span>${ci.qty}</span>
      <button class="btn" onclick="inc('${ci.id}')">ï¼‹</button>
      <b>${money(p.price*ci.qty)}</b></div>`;
  }).join("") || '<div class="muted">è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</div>';

  const coupons = state.coupons.filter(c=>c.acquired && !c.used && c.type!=='offline');
  const total = state.cart.items.reduce((s,ci)=> s + state.products.find(p=>p.id===ci.id).price*ci.qty, 0);
  const coupon = coupons.find(c=>c.id===state.cart.couponId);
  const discount = coupon && total>=coupon.threshold ? (coupon.type==='cash'?coupon.value:0) : 0;
  const pay = Math.max(0, total - discount);

  box.innerHTML = `
    <div class="section-title">è´­ç‰©è½¦</div>
    ${items}
    <div class="line"></div>
    <div class="flex">
      <div>ä¼˜æƒ åˆ¸ï¼š</div>
      <select id="applyCoupon">
        <option value="">ä¸ä½¿ç”¨</option>
        ${coupons.map(c=>`<option value="${c.id}" ${state.cart.couponId===c.id?'selected':''}>${c.title}ï¼ˆæ»¡${c.threshold}ï¼‰</option>`).join("")}
      </select>
      <div class="space"></div>
      <div>å°è®¡ï¼š<b>${money(total)}</b>  &nbsp; æŠµæ‰£ï¼š<b>${money(discount)}</b>  &nbsp; åº”ä»˜ï¼š<b>${money(pay)}</b></div>
    </div>
    <div class="line"></div>
    <div class="flex">
      <select id="channel"><option>å¾®ä¿¡æ”¯ä»˜</option><option>æ”¯ä»˜å®</option><option>é“¶è¡Œå¡</option></select>
      <div class="space"></div>
      <button class="btn ok" onclick="checkout()">ä¸‹å•æ”¯ä»˜</button>
      <button class="btn ghost" onclick="closeCart()">å…³é—­</button>
    </div>`;
  $("#applyCoupon").onchange=e=>{ state.cart.couponId=e.target.value||null; saveState(); openCart(); };
}
function closeCart(){ $("#drawerCart").classList.remove("show"); }
function addToCart(id){
  const it = state.cart.items.find(x=>x.id===id);
  if(it) it.qty++; else state.cart.items.push({id,qty:1});
  saveState(); renderCartCount(); toast("å·²åŠ å…¥è´­ç‰©è½¦"); track("add_cart",{id});
}
function inc(id){ const it=state.cart.items.find(x=>x.id===id); it.qty++; saveState(); openCart(); }
function dec(id){ const it=state.cart.items.find(x=>x.id===id); if(--it.qty<=0) state.cart.items=state.cart.items.filter(x=>x.id!==id); saveState(); openCart(); }
function checkout(){
  if(!state.cart.items.length){ toast("è´­ç‰©è½¦ä¸ºç©º"); return; }
  const channel=$("#channel").value;
  const coupons = state.coupons.filter(c=>c.acquired && !c.used && c.type!=='offline');
  const total = state.cart.items.reduce((s,ci)=> s + state.products.find(p=>p.id===ci.id).price*ci.qty, 0);
  const coupon = coupons.find(c=>c.id===state.cart.couponId);
  const discount = coupon && total>=coupon.threshold ? (coupon.type==='cash'?coupon.value:0) : 0;
  const pay = Math.max(0, total - discount);

  // ç”Ÿæˆè®¢å•
  const oid = "OD"+Date.now().toString().slice(-6);
  const logistics=[
    {time:new Date().toLocaleString(), desc:"è®¢å•å·²åˆ›å»º"},
    {time:new Date(Date.now()+3600e3).toLocaleString(), desc:"ä»“åº“æ‹£è´§ä¸­"},
    {time:new Date(Date.now()+7200e3).toLocaleString(), desc:"å·²å‘å‡ºï¼Œè¿è¾“ä¸­"},
  ];
  state.orders.unshift({id:oid, items:structuredClone(state.cart.items), pay, status:"è¿è¾“ä¸­", channel, logistics});
  // ç§¯åˆ†æˆé•¿
  const growth = Math.round(pay*10*getLevel().mult);
  state.user.points += growth;

  // åˆ¸ç½®ä¸ºå·²ç”¨
  if(coupon) coupon.used=true;
  // æ¸…ç©ºè´­ç‰©è½¦
  state.cart={items:[], couponId:null};
  saveState();

  toast("æ”¯ä»˜æˆåŠŸï¼Œè®¢å•å·²åˆ›å»º"); track("pay_ok",{oid,pay,channel});
  closeCart(); current="me"; render();
}

/* ------------------------- åŸ‹ç‚¹æ—¥å¿— ------------------------- */
function openLogs(){
  const box=$("#drawerLogs");
  box.classList.add("show");
  const logtxt = state.logs.slice(0,80).map(l=>`${l.t}  [${l.event}]  ${JSON.stringify(l.payload)}`).join("\n");
  box.innerHTML = `<div class="section-title">åŸ‹ç‚¹æ—¥å¿—</div><div class="log">${logtxt||"æš‚æ— æ—¥å¿—"}</div>
  <div class="line"></div><button class="btn ghost" onclick="$('#drawerLogs').classList.remove('show')">å…³é—­</button>`;
}

/* ------------------------- é¡¶éƒ¨æŒ‰é’®ç»‘å®š ------------------------- */
$("#btnCart").onclick=openCart;
$("#btnLogs").onclick=openLogs;
$("#modeCulture").onclick=()=>setMode('culture');
$("#modeDirect").onclick=()=>setMode('direct');

/* ------------------------- å¯åŠ¨ ------------------------- */
function openCaseFromHome(){ current="cases"; render(); }
function renderCart(){ openCart(); }
function openDetailFromHome(id){ openDetail(id); }
function openCartFromHome(){ openCart(); }
function openCase(id){ openCase = openCase; } // placeholder (å·²åœ¨ä¸Šæ–¹å®ç°)
function setTabs(){ renderNav(); }
function openCartDrawer(){ openCart(); }
function gotoMe(){ current="me"; render(); }
function addPoint(n){ state.user.points+=n; saveState(); render(); }
function openCase(id){ // è¦†ç›–å‰é¢çš„å ä½å®šä¹‰ï¼Œé¿å…é‡å¤å£°æ˜è­¦å‘Š
  const s=state.cases.find(x=>x.id===id); const p=state.products.find(x=>x.id===s.link);
  const html=`
    <div class="card">
      <div class="section-title">ğŸ“ ${s.title}</div>
      <p class="muted">ï¼ˆçŸ­æ–‡ç¤ºä¾‹ï¼‰${s.brief}ã€‚æˆ‘ä»¬ä¸ä½œè€…æ²Ÿé€šï¼Œå°†ä½œå“ä¸ç”Ÿæ´»ç©ºé—´ç»“åˆâ€¦â€¦</p>
      <div class="line"></div>
      <div><b>æ–‡ä¸­æåˆ°çš„å•†å“ï¼š</b></div>
      <div style="margin-top:8px">${prodCard(p)}</div>
    </div>`;
  $("#drawerCart").innerHTML=html; $("#drawerCart").classList.add("show");
}
function renderInit(){
  render(); track("app_open");
}
renderInit();
</script>
</body>
</html>
