<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>æ–°é›¶å”®å•†åŸ Â· PRD V2.0 å¯¹é½ç§»åŠ¨ç«¯ Demo</title>
<style>
  :root{
    --bg:#f7f8fa; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --brand:#3b82f6; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --card:#fff;
    --radius:16px; --shadow:0 10px 24px rgba(0,0,0,.06);
    --tabH:60px; --safeTop:env(safe-area-inset-top); --safeBottom:env(safe-area-inset-bottom);
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,Inter,"Noto Sans SC",Helvetica,Arial;}
  a{text-decoration:none;color:inherit}
  button{border:0;background:none}
  .page{padding:12px 12px calc(var(--tabH) + 12px + var(--safeBottom));max-width:768px;margin:0 auto}
  /* é¡¶éƒ¨æ  */
  .topbar{position:sticky;top:0;z-index:9;background:rgba(247,248,250,.92);
    backdrop-filter:blur(8px);padding:10px 12px calc(8px + var(--safeTop));
    border-bottom:1px solid var(--line)}
  .brand{font-weight:800;letter-spacing:.3px}
  .row{display:flex;align-items:center;gap:8px}
  .space{flex:1}
  .search{display:flex;gap:10px;margin-top:8px}
  .input,select,textarea{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:15px}
  .btn{border-radius:12px;background:var(--brand);color:#fff;padding:12px 14px;font-weight:600}
  .btn.ghost{background:#fff;border:1px solid var(--brand);color:var(--brand)}
  .btn.plain{background:#fff;border:1px solid var(--line);color:var(--ink)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media (min-width:560px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media (min-width:920px){ .grid{grid-template-columns:repeat(4,1fr)} }
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:13px}
  .chip.on{background:#111;color:#fff;border-color:#111}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  /* å•†å“å¡ */
  .prod{display:flex;flex-direction:column;gap:8px}
  .thumb{height:140px;border-radius:12px;background:linear-gradient(135deg,#eef2ff,#e8fff4);display:flex;align-items:center;justify-content:center;font-size:48px}
  .price{font-weight:800}
  .tag{font-size:11px;padding:3px 6px;border-radius:6px;background:#eef2ff;color:#3730a3}
  /* è½®æ’­ */
  .carousel{position:relative;height:180px;border-radius:14px;overflow:hidden;background:#0b1020;color:#fff;display:flex;align-items:center;justify-content:center}
  .dots{position:absolute;bottom:10px;display:flex;gap:6px}
  .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.5)}
  .dot.on{background:#fff}
  /* TabBar */
  .tabbar{position:fixed;left:0;right:0;bottom:0;height:calc(var(--tabH) + var(--safeBottom));background:#fff;border-top:1px solid var(--line);
    display:flex;align-items:flex-start;justify-content:space-around;padding-top:8px;padding-bottom:calc(8px + var(--safeBottom));z-index:10}
  .tab{display:flex;flex-direction:column;align-items:center;gap:4px;width:20%;font-size:12px;color:#64748b}
  .tab.active{color:#111}
  .badge{font-size:11px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 6px}
  /* æŠ½å±‰ä¸ Toast */
  .drawer{position:fixed;right:12px;left:12px;top:80px;bottom:calc(var(--tabH) + 16px + var(--safeBottom));overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.18);padding:12px;display:none;z-index:50}
  .drawer.show{display:block}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(22px + var(--safeBottom));background:#111;color:#fff;padding:11px 16px;border-radius:12px;opacity:0;transition:.25s;z-index:99}
  .toast.show{opacity:1}
  /* éª¨æ¶å± */
  .skeleton{background:linear-gradient(90deg,#eee 25%,#f7f7f7 37%,#eee 63%);background-size:400% 100%;animation:s 1.2s ease infinite}
  @keyframes s{0%{background-position:100% 50%} 100%{background-position:0% 50%}}
</style>
</head>
<body>
  <!-- é¡¶éƒ¨æ  -->
  <div class="topbar">
    <div class="row">
      <div class="brand">ğŸ›ï¸ æ–°é›¶å”®å•†åŸ</div>
      <span class="chip" id="roleTag">è§’è‰²ï¼šæ¸¸å®¢</span>
      <div class="space"></div>
      <button class="chip" id="btnRole">åˆ‡æ¢è§’è‰²</button>
      <button class="chip" id="btnCart">è´­ç‰©è½¦ <span id="cartCount" class="badge">0</span></button>
      <button class="chip" id="btnLogs">æ—¥å¿—</button>
    </div>
    <div class="search">
      <input id="globalSearch" class="input" placeholder="æœå•†å“ / è§„æ ¼ / åˆ¸ç â€¦" />
      <button class="btn ghost" id="btnScan">æ‰«ç </button>
    </div>
  </div>

  <!-- é¡µé¢å®¹å™¨ -->
  <main id="app" class="page"></main>

  <!-- TabBar -->
  <nav class="tabbar" id="tabbar">
    <div class="tab" data-id="home"><div>ğŸ </div><div>é¦–é¡µ</div></div>
    <div class="tab" data-id="shop"><div>ğŸ›’</div><div>å•†åŸ</div></div>
    <div class="tab" data-id="cases"><div>ğŸ“–</div><div>æ–‡åŒ–</div></div>
    <div class="tab" data-id="coupon"><div>ğŸ«</div><div>é¢†åˆ¸</div></div>
    <div class="tab" data-id="me"><div>ğŸ‘¤</div><div>æˆ‘çš„</div></div>
  </nav>

  <!-- æŠ½å±‰ï¼šè´­ç‰©è½¦/æ—¥å¿—/è¯¦æƒ…/æ ¸é”€ç­‰ -->
  <div id="drawer" class="drawer"></div>
  <div id="toast" class="toast"></div>

<script>
/* ================= çŠ¶æ€ï¼ˆæŒ‰ PRD V2.0 ç»“æ„ï¼‰ ================ */
const KEY='mall_prd_v2_state';
const S = JSON.parse(localStorage.getItem(KEY)||'null') || {
  role:'guest', // guest/operator/clerk/finance
  mode:'culture',
  cart:{ items:[], couponId:null },
  coupons:[
    {id:'C200-20', title:'æ»¡200å‡20', type:'cash', threshold:200, value:20, acquired:false, used:false},
    {id:'C400-50', title:'æ»¡400å‡50', type:'cash', threshold:400, value:50, acquired:false, used:false},
    {id:'OFF-COFFEE', title:'çº¿ä¸‹å’–å•¡åˆ¸', type:'offline', threshold:0, value:1, code:'COFFEE-2025', acquired:false, used:false}
  ],
  // äºŒçº§åˆ†ç±»ï¼šcat->subCat
  products:[
    {sku:'A101-01', name:'æ‰‹å·¥æœ¨æ‰˜ç›˜', price:129, rating:4.7, cat:'å®¶å±…', sub:'é¤å¨', icon:'ğŸªµ', stock:18, sales:320, tags:['å¤©ç„¶','æ‰‹ä½œ'], specs:['åŸæœ¨','èƒ¡æ¡ƒæœ¨']},
    {sku:'A102-01', name:'åŒ—æ¬§é¦™è–°èœ¡çƒ›', price:89, rating:4.5, cat:'å®¶å±…', sub:'é¦™æ°›', icon:'ğŸ•¯ï¸', stock:50, sales:860, tags:['é¦™æ°›','æ²»æ„ˆ'], specs:['ç™½èŒ¶','æµ·ç›']},
    {sku:'B201-01', name:'åŸåˆ›ç‰ˆç”»Â·æµ·é£', price:399, rating:4.9, cat:'è‰ºæœ¯', sub:'æŒ‚ç”»', icon:'ğŸ–¼ï¸', stock:6, sales:120, tags:['é™é‡','åŸåˆ›'], specs:['A3','A2']},
    {sku:'B202-01', name:'æ‰‹ä½œé™¶æ¯', price:159, rating:4.6, cat:'è‰ºæœ¯', sub:'é™¶å™¨', icon:'ğŸº', stock:22, sales:540, tags:['åŒ å¿ƒ'], specs:['æµ…ç°','é›è“']},
    {sku:'C301-12', name:'æŒ‚è€³å’–å•¡ 12åŒ…', price:98, rating:4.4, cat:'å’–å•¡', sub:'è€—æ', icon:'â˜•', stock:120, sales:2100, tags:['æ‹¼é…'], specs:['æµ…ç„™','ä¸­ç„™']},
    {sku:'C302-60', name:'å†·èƒç“¶ 600ml', price:69, rating:4.2, cat:'å’–å•¡', sub:'å™¨å…·', icon:'ğŸ§Š', stock:45, sales:780, tags:['å¤æ—¥'], specs:['å•ç“¶']},
    {sku:'D401-01', name:'è“ç‰™éŸ³ç®± mini', price:299, rating:4.5, cat:'æ•°ç ', sub:'éŸ³é¢‘', icon:'ğŸ“»', stock:28, sales:980, tags:['ä¾¿æº'], specs:['é»‘','ç™½']},
    {sku:'D402-01', name:'é˜…è¯»å°ç¯', price:189, rating:4.3, cat:'æ•°ç ', sub:'ç…§æ˜', icon:'ğŸ’¡', stock:46, sales:620, tags:['æŠ¤çœ¼'], specs:['æš–å…‰','ä¸­æ€§å…‰']}
  ],
  articles:[
    {id:'S1', title:'ä¸€åªæ‰˜ç›˜çš„æ—…è¡Œ', cover:'ğŸªµ', brief:'ä»åºŸæœ¨åˆ°é¤æ¡Œçš„äºŒæ¬¡ç”Ÿå‘½', link:'A101-01'},
    {id:'S2', title:'ç”»é‡Œçš„é£', cover:'ğŸ–¼ï¸', brief:'åŸåˆ›ç‰ˆç”»èƒŒåçš„åˆ›ä½œæ‰‹è®°', link:'B201-01'}
  ],
  orders:[],
  user:{name:'æ¸¸å®¢', points:0, address:'', favs:[], level:'æ™®é€š'},
  logs:[]
};
const save=()=>localStorage.setItem(KEY, JSON.stringify(S));
const $=(s,root=document)=>root.querySelector(s);
const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));
const money=n=>'Â¥'+n.toFixed(2);
const tip=t=>{const x=$("#toast"); x.textContent=t; x.classList.add('show'); setTimeout(()=>x.classList.remove('show'),1400);};
const log=(e,p={})=>{S.logs.unshift({t:new Date().toLocaleString(),e,p}); save();};

/* ============== è·¯ç”± ============== */
const PAGES={
  home(root){
    root.innerHTML=`
      <section class="card">
        <div class="carousel" id="caro"><b>å¤æ—¥ä¸Šæ–° Â· å†…å®¹ç§è‰</b><div class="dots"><span class="dot on"></span><span class="dot"></span><span class="dot"></span></div></div>
        <div class="row" style="gap:10px;margin-top:10px">
          <button class="btn" data-go="shop">å»é€›å•†åŸ</button>
          <button class="btn ghost" data-go="coupon">é¢†åˆ¸ä¸­å¿ƒ</button>
          <button class="btn plain" data-go="scan">æ‰«ç ç›´è¾¾</button>
          <div class="space"></div>
          <span class="chip ${S.mode==='culture'?'on':''}" data-mode="culture">æ–‡åŒ–ä¼˜å…ˆ</span>
          <span class="chip ${S.mode==='direct'?'on':''}" data-mode="direct">å¯¼æµä¼˜å…ˆ</span>
        </div>
      </section>

      ${S.mode==='culture' ? blockCulture()+blockHot()+blockLead() : blockHot()+blockLead()+blockCulture()}
    `;
    // äº‹ä»¶ç»‘å®š
    $$('[data-go]',root).forEach(b=>b.onclick=()=>render(b.dataset.go));
    $$('[data-mode]',root).forEach(x=>x.onclick=()=>{S.mode=x.dataset.mode; save(); render('home'); tip(S.mode==='culture'?'æ–‡åŒ–ä¼˜å…ˆ':'å¯¼æµä¼˜å…ˆ');});
    // è½®æ’­ç‚¹
    let idx=0; setInterval(()=>{const ds=$$('.dot',root); ds.forEach(d=>d.classList.remove('on')); idx=(idx+1)%ds.length; ds[idx].classList.add('on')},2400);

    function blockHot(){
      const hot = [...S.products].sort((a,b)=>b.sales-a.sales).slice(0,4);
      return `<section class="card"><b>çƒ­é—¨çˆ†æ¬¾</b>
        <div class="grid" style="margin-top:8px">${hot.map(prodCard).join('')}</div></section>`;
    }
    function blockCulture(){
      return `<section class="card"><b>ç²¾é€‰æ–‡åŒ–/æ¡ˆä¾‹</b>
        <div class="grid" style="margin-top:8px">${S.articles.map(a=>`
          <div class="card prod">
            <div class="thumb">${a.cover}</div>
            <b>${a.title}</b><div class="muted">${a.brief}</div>
            <div class="row"><div class="space"></div><button class="btn ghost" onclick="openArticle('${a.id}')">é˜…è¯»</button></div>
          </div>`).join('')}</div></section>`;
    }
    function blockLead(){
      return `<section class="card"><b>å¿«é€Ÿå…¥å£</b>
        <div class="kpi" style="margin-top:8px">
          <div class="card"><b>ä¼˜æƒ åˆ¸</b><div class="muted">æ»¡å‡/çº¿ä¸‹æ ¸é”€</div><div class="row" style="margin-top:8px"><div class="space"></div><button class="btn ghost" data-go="coupon">å»é¢†å–</button></div></div>
          <div class="card"><b>æ‰«ç è´­</b><div class="muted">ä¸€ç‰©ä¸€ç ç›´è¾¾</div><div class="row" style="margin-top:8px"><div class="space"></div><button class="btn ghost" data-go="scan">å»æ‰«ç </button></div></div>
          <div class="card"><b>ç›´æ’­/é¢„çº¦</b><div class="muted">åæœŸæ¥å…¥</div><div class="row" style="margin-top:8px"><div class="space"></div><button class="btn" disabled>æ•¬è¯·æœŸå¾…</button></div></div>
        </div></section>`;
    }
  },

  shop(root){
    const cats = groupByCat(); // {cat: [subs]}
    const catList = Object.keys(cats);
    let cat = catList[0]||'',
        sub = cats[cat]?.[0]||'å…¨éƒ¨',
        sort='ç»¼åˆ', keyword='', priceOrder='ç»¼åˆ';

    root.innerHTML=`
      <section class="card">
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <div class="chips" id="cats">${catList.map(c=>`<span class="chip ${c===cat?'on':''}" data-cat="${c}">${c}</span>`).join('')}</div>
          <div class="chips" id="subs" style="margin-left:-4px">${(cats[cat]||[]).map(s=>`<span class="chip ${s===sub?'on':''}" data-sub="${s}">${s}</span>`).join('')}</div>
          <div class="space"></div>
          <select id="sort">
            <option>ç»¼åˆ</option><option>é”€é‡â¬†</option><option>ä»·æ ¼â¬†</option><option>ä»·æ ¼â¬‡</option><option>ä¸Šæ–°</option>
          </select>
          <button class="chip" onclick="openCart()">ğŸ›’ è´­ç‰©è½¦</button>
        </div>
      </section>
      <div id="list" class="grid" style="margin-top:10px"></div>
    `;
    const list=$("#list",root);
    // æœç´¢è”åŠ¨
    $("#globalSearch").oninput=e=>{keyword=e.target.value.trim(); apply();};
    // åˆ†ç±»åˆ‡æ¢
    $("#cats",root).onclick=e=>{
      const n=e.target.closest('.chip'); if(!n) return;
      cat=n.dataset.cat; sub=(cats[cat]||[])[0]||'å…¨éƒ¨'; renderSubs(); apply();
    };
    $("#subs",root).onclick=e=>{
      const n=e.target.closest('.chip'); if(!n) return; sub=n.dataset.sub; apply();
    };
    $("#sort",root).onchange=e=>{sort=e.target.value; apply();};

    function renderSubs(){
      $("#subs",root).innerHTML=(cats[cat]||[]).map(s=>`<span class="chip ${s===sub?'on':''}" data-sub="${s}">${s}</span>`).join('');
      $$('#cats .chip',root).forEach(c=>c.classList.toggle('on', c.dataset.cat===cat));
    }
    function apply(){
      let arr=[...S.products].filter(p=>p.cat===cat && p.sub===sub);
      if(keyword) arr=arr.filter(p=>p.name.includes(keyword)||(p.tags||[]).some(t=>t.includes(keyword))||(p.specs||[]).some(sp=>sp.includes(keyword)));
      if(sort==='é”€é‡â¬†') arr.sort((a,b)=>b.sales-a.sales);
      if(sort==='ä»·æ ¼â¬†') arr.sort((a,b)=>a.price-b.price);
      if(sort==='ä»·æ ¼â¬‡') arr.sort((a,b)=>b.price-a.price);
      if(sort==='ä¸Šæ–°') arr.sort((a,b)=>b.sku.localeCompare(a.sku)); // ç®€åŒ–ï¼šSKU å°¾å·è¶Šå¤§è¶Šæ–°
      list.innerHTML = arr.map(prodCard).join('') || `<div class="card skeleton" style="height:120px"></div>`;
    }
    apply();
  },

  cases(root){
    root.innerHTML=`<section class="grid">${S.articles.map(a=>`
      <div class="card prod">
        <div class="thumb">${a.cover}</div>
        <b>${a.title}</b><div class="muted">${a.brief}</div>
        <div class="row"><div class="space"></div><button class="btn ghost" onclick="openArticle('${a.id}')">é˜…è¯»</button></div>
      </div>`).join('')}</section>`;
  },

  coupon(root){
    root.innerHTML=`
      <section class="grid">
        ${S.coupons.map(c=>`
          <div class="card prod">
            <div class="thumb" style="font-size:40px;background:linear-gradient(135deg,#fff7ed,#fee2e2)">${c.type==='offline'?'ğŸ·ï¸':'ğŸ’¸'}</div>
            <b>${c.title}</b>
            <div class="muted">${c.type==='offline'?'åˆ°åº—æ‰«ç æ ¸é”€ï¼ˆåº—å‘˜ç«¯ï¼‰':'ä¸‹å•å¯ç”¨ï¼ˆæ»¡å‡ï¼‰'}</div>
            ${c.type==='offline'?`<div class="muted">æ ¸é”€ç ï¼š<b>${c.code}</b></div>`:''}
            <div class="row"><div class="space"></div>
              ${c.acquired?'<span class="badge">å·²é¢†å–</span>':`<button class="btn" onclick="claimCoupon('${c.id}')">é¢†å–</button>`}
            </div>
          </div>`).join('')}
      </section>

      <section class="card" style="margin-top:10px">
        <b>æ ¸é”€å°ï¼ˆåº—å‘˜ï¼‰</b> ${S.role!=='clerk'?'<span class="tag">éœ€åº—å‘˜è§’è‰²</span>':''}
        <div class="row" style="gap:8px;margin-top:8px">
          <input id="verifyCode" class="input" placeholder="è¾“å…¥çº¿ä¸‹åˆ¸ç  å¦‚ï¼šCOFFEE-2025" ${S.role!=='clerk'?'disabled':''}/>
          <button class="btn" id="doVerify" ${S.role!=='clerk'?'disabled':''}>æ ¸é”€</button>
        </div>
        <div id="verifyResult" class="muted" style="margin-top:8px"></div>
      </section>
    `;
    $("#doVerify",root)?.addEventListener('click',()=>{
      const code = $("#verifyCode",root).value.trim();
      const c = S.coupons.find(x=>x.type==='offline' && x.code===code);
      const box=$("#verifyResult",root);
      if(!c) return box.textContent="æœªæ‰¾åˆ°åˆ¸ç ";
      if(!c.acquired) return box.textContent="ç”¨æˆ·æœªé¢†å–ï¼Œæ— æ³•æ ¸é”€";
      if(c.used) return box.textContent="è¯¥åˆ¸å·²ä½¿ç”¨";
      c.used=true; save(); box.textContent="âœ… å·²æ ¸é”€ï¼š"+c.title; tip("æ ¸é”€æˆåŠŸ"); log('verify_ok',{id:c.id});
    });
  },

  me(root){
    const u=S.user, percent=Math.min(100,(u.points%3000)/30);
    // è®¢å•çŠ¶æ€åˆ†æ 
    const tabs=['å¾…ä»˜æ¬¾','å¾…å‘è´§','å¾…æ”¶è´§','å·²å®Œæˆ','å·²å–æ¶ˆ'];
    let tab='å…¨éƒ¨';
    root.innerHTML=`
      <section class="card">
        <div class="row"><b>ä¼šå‘˜ç­‰çº§</b><div class="space"></div><span class="badge">${getLevel().level}</span></div>
        <div class="muted" style="margin-top:6px">ç§¯åˆ†ï¼š${u.points} Â· æˆé•¿ = å®ä»˜ Ã— 10 Ã— ç­‰çº§ç³»æ•°</div>
        <div style="height:8px;border-radius:999px;background:#eef2ff;margin-top:8px"><i style="display:block;height:100%;width:${percent}%;background:var(--brand)"></i></div>
        <div class="row" style="gap:8px;margin-top:10px">
          <input id="addr" class="input" placeholder="çœå¸‚åŒº + è¯¦ç»†åœ°å€" value="${u.address||''}"/>
          <button class="btn ghost" onclick="saveAddr()">ä¿å­˜</button>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button class="chip" onclick="tip('å®¢æœå ä½')">ğŸ•‘ å®¢æœ</button>
          <button class="chip" onclick="tip('æ”¶è—å ä½')">â­ æ”¶è—</button>
        </div>
      </section>

      <section class="card" style="margin-top:10px">
        <div class="row" style="flex-wrap:wrap;gap:6px">
          <b>æˆ‘çš„è®¢å•</b>
          <div class="space"></div>
          <span class="chip on" data-st="å…¨éƒ¨">å…¨éƒ¨</span>
          ${tabs.map(t=>`<span class="chip" data-st="${t}">${t}</span>`).join('')}
        </div>
        <div id="orders" style="margin-top:8px"></div>
      </section>
    `;
    const box=$("#orders",root);
    const setTab=(st)=>{tab=st; renderOrders();}
    root.addEventListener('click',(e)=>{const c=e.target.closest('.chip'); if(c&&c.dataset.st){ $$('#me .chip').forEach(x=>x.classList.remove('on')); c.classList.add('on'); setTab(c.dataset.st);} });
    renderOrders();

    function renderOrders(){
      let arr=[...S.orders];
      if(tab!=='å…¨éƒ¨'){ arr=arr.filter(o=>o.status===tab); }
      box.innerHTML = arr.length? arr.map(orderCard).join(''): '<div class="muted">æš‚æ— è®¢å•</div>';
    }
  },

  scan(root){
    root.innerHTML=`
      <section class="card">
        <b>æ‰«ç ç›´è¾¾</b>
        <div class="row" style="gap:8px;margin-top:8px">
          <input id="scanStr" class="input" placeholder="è¾“å…¥äºŒç»´ç å­—ç¬¦ä¸²ï¼šPROD-A101-01" />
          <button class="btn" id="goScan">æ‰“å¼€</button>
        </div>
        <div id="scanResult" style="margin-top:10px"></div>
      </section>`;
    $("#goScan",root).onclick=()=>{
      const v=$("#scanStr",root).value.trim(); const sku=(v.split('PROD-')[1]||'').toUpperCase();
      const p=S.products.find(x=>x.sku===sku);
      $("#scanResult",root).innerHTML = p ? `<div class="card">${prodCard(p)}</div>` : `<div class="muted">æœªæ‰¾åˆ°å•†å“</div>`;
    };
  }
};

/* ============== å…±ç”¨ UI ============== */
function prodCard(p){
  return `<div class="card prod">
    <div class="thumb">${p.icon}</div>
    <b>${p.name}</b>
    <div class="muted">ç±»åˆ«ï¼š${p.cat}/${p.sub} Â· è¯„åˆ† ${p.rating} Â· é”€é‡ ${p.sales}</div>
    <div class="row" style="gap:6px;flex-wrap:wrap">
      ${(p.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}
      <div class="space"></div>
      <button class="chip" onclick="openDetail('${p.sku}')">è¯¦æƒ…</button>
      <button class="btn" onclick="addToCart('${p.sku}')">åŠ å…¥</button>
    </div>
  </div>`;
}
function orderCard(o){
  return `<div class="card" style="margin-top:8px">
    <div class="row"><b>è®¢å• ${o.id}</b><div class="space"></div><span class="badge">${o.status}</span></div>
    <div class="muted">é‡‘é¢ï¼š${money(o.pay)} Â· æ”¯ä»˜ï¼š${o.channel}</div>
    <div class="muted">å•†å“ï¼š${o.items.map(i=>i.sku+'Ã—'+i.qty).join('ï¼Œ')}</div>
    <div class="row" style="margin-top:8px;gap:8px">
      <button class="chip" onclick="showLogistics('${o.id}')">æŸ¥çœ‹ç‰©æµ</button>
      ${o.status==='å¾…ä»˜æ¬¾'?`<button class="chip" onclick="tip('å»ä»˜æ¬¾å ä½')">å»ä»˜æ¬¾</button>`:''}
      ${o.status==='å¾…å‘è´§'?`<button class="chip" onclick="tip('ç”³è¯·é€€æ¬¾å ä½')">ç”³è¯·é€€æ¬¾</button>`:''}
    </div>
  </div>`;
}

/* ============== ä¸šåŠ¡ï¼šåˆ†ç±»åˆ†ç»„ã€è¯¦æƒ…ã€è§„æ ¼ã€æ”¶è—ã€æ‰«ç ã€æ–‡ç«  ============== */
function groupByCat(){
  const map={}; S.products.forEach(p=>{ map[p.cat]=map[p.cat]||new Set(); map[p.cat].add(p.sub); });
  const res={}; Object.keys(map).forEach(k=>res[k]=[...map[k]]); return res;
}
function openDetail(sku){
  const p=S.products.find(x=>x.sku===sku);
  const code=`PROD-${p.sku}`;
  const d=$("#drawer"); d.classList.add('show');
  d.innerHTML = `
    <div class="row"><b>${p.name}</b><div class="space"></div><button class="chip" onclick="closeDrawer()">å…³é—­</button></div>
    <!-- è½®æ’­å›¾ä¸è§†é¢‘å ä½ -->
    <div class="card" style="margin-top:8px">
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <div class="thumb" style="flex:1 1 160px">${p.icon}</div>
        <div class="thumb" style="flex:1 1 160px">ğŸ–¼ï¸</div>
        <div class="thumb" style="flex:1 1 160px">ğŸï¸ è§†é¢‘</div>
      </div>
    </div>
    <div class="row" style="margin-top:8px;gap:8px">
      <div class="price">${money(p.price)}</div><span class="muted">åº“å­˜ ${p.stock}</span>
      <div class="space"></div><span class="muted">äºŒç»´ç ï¼š<b>${code}</b></span>
    </div>
    <div style="margin-top:8px">
      <b>è§„æ ¼ï¼š</b> ${(p.specs||[]).map((sp,i)=>`<label class="chip"><input type="radio" name="spec" ${i===0?'checked':''} style="display:none"/>${sp}</label>`).join('')}
    </div>
    <div class="muted" style="margin-top:6px">è¿è´¹æ”¿ç­–/é€€æ¢è´§è¯´æ˜ï¼ˆç¤ºä¾‹å ä½ï¼‰</div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button class="btn" onclick="addToCart('${p.sku}')">åŠ å…¥è´­ç‰©è½¦</button>
      <button class="btn ghost" onclick="buyNow('${p.sku}')">ç«‹å³è´­ä¹°</button>
      <div class="space"></div>
      <button class="chip" onclick="fav('${p.sku}')">â­ æ”¶è—</button>
    </div>`;
  log('view_detail',{sku});
}
function openArticle(id){
  const a=S.articles.find(x=>x.id===id), p=S.products.find(x=>x.sku===a.link);
  const d=$("#drawer"); d.classList.add('show');
  d.innerHTML = `<div class="row"><b>ğŸ“ ${a.title}</b><div class="space"></div><button class="chip" onclick="closeDrawer()">å…³é—­</button></div>
    <p class="muted" style="margin-top:6px">${a.brief}â€¦â€¦ï¼ˆå›¾æ–‡/è§†é¢‘å ä½ï¼‰</p>
    <div class="card" style="margin-top:10px"><b>æ–‡ä¸­ç›¸å…³å•†å“</b><div style="margin-top:8px">${prodCard(p)}</div></div>`;
}
function fav(sku){
  const idx=S.user.favs.indexOf(sku);
  if(idx===-1){ S.user.favs.push(sku); tip('å·²æ”¶è—'); } else { S.user.favs.splice(idx,1); tip('å·²å–æ¶ˆæ”¶è—'); }
  save();
}

/* ============== è´­ç‰©è½¦ä¸ç»“ç®— ============== */
function updateCartCount(){ $("#cartCount").textContent = S.cart.items.reduce((s,i)=>s+i.qty,0); }
function addToCart(sku){ const it=S.cart.items.find(x=>x.sku===sku); it?it.qty++:S.cart.items.push({sku,qty:1}); save(); updateCartCount(); tip('å·²åŠ å…¥è´­ç‰©è½¦'); log('add_cart',{sku}); }
function buyNow(sku){ S.cart.items=[{sku,qty:1}]; save(); openCart(); }
function openCart(){
  const d=$("#drawer"); d.classList.add('show');
  const items=S.cart.items.map(ci=>{
    const p=S.products.find(x=>x.sku===ci.sku);
    return `<div class="row"><span>${p.name}</span><div class="space"></div>
      <button class="chip" onclick="dec('${ci.sku}')">ï¼</button><b>${ci.qty}</b><button class="chip" onclick="inc('${ci.sku}')">ï¼‹</button>
      <b>${money(p.price*ci.qty)}</b></div>`;
  }).join('') || '<div class="muted">è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</div>';

  const coupons=S.coupons.filter(c=>c.acquired && !c.used && c.type!=='offline');
  const total=S.cart.items.reduce((s,ci)=>s+S.products.find(p=>p.sku===ci.sku).price*ci.qty,0);
  const cpn=coupons.find(c=>c.id===S.cart.couponId);
  const discount = cpn && total>=cpn.threshold ? (cpn.type==='cash'?cpn.value:0) : 0;
  const pay=Math.max(0,total-discount);

  d.innerHTML=`
    <div class="row"><b>è´­ç‰©è½¦</b><div class="space"></div><button class="chip" onclick="closeDrawer()">å…³é—­</button></div>
    <div style="margin-top:8px">${items}</div>
    <hr style="border:none;border-top:1px solid var(--line);margin:10px 0">
    <div class="row" style="gap:8px">
      <span>ä¼˜æƒ åˆ¸ï¼š</span>
      <select id="applyCpn" class="chip"><option value="">ä¸ä½¿ç”¨</option>${coupons.map(c=>`<option value="${c.id}" ${S.cart.couponId===c.id?'selected':''}>${c.title}</option>`).join('')}</select>
      <div class="space"></div>
      <div>å°è®¡ <b>${money(total)}</b> æŠµæ‰£ <b>${money(discount)}</b> åº”ä»˜ <b>${money(pay)}</b></div>
    </div>
    <div class="row" style="margin-top:10px;gap:8px">
      <select id="channel" class="chip"><option>å¾®ä¿¡æ”¯ä»˜</option><option>æ”¯ä»˜å®</option><option>é“¶è¡Œå¡</option></select>
      <select id="ship" class="chip"><option>å¿«é€’é…é€</option><option>åˆ°åº—è‡ªæ</option></select>
      <div class="space"></div>
      <button class="btn" onclick="checkout()">ä¸‹å•æ”¯ä»˜</button>
    </div>`;
  $("#applyCpn").onchange=e=>{ S.cart.couponId=e.target.value||null; save(); openCart(); };
}
function closeDrawer(){ $("#drawer").classList.remove('show'); }
function inc(sku){ const it=S.cart.items.find(x=>x.sku===sku); it.qty++; save(); openCart(); }
function dec(sku){ const it=S.cart.items.find(x=>x.sku===sku); if(--it.qty<=0) S.cart.items=S.cart.items.filter(x=>x.sku!==sku); save(); openCart(); }
function checkout(){
  if(!S.cart.items.length) return tip('è´­ç‰©è½¦ä¸ºç©º');
  const channel=$("#channel").value;
  const coupons=S.coupons.filter(c=>c.acquired && !c.used && c.type!=='offline');
  const total=S.cart.items.reduce((s,ci)=>s+S.products.find(p=>p.sku===ci.sku).price*ci.qty,0);
  const cpn=coupons.find(c=>c.id===S.cart.couponId);
  const discount=cpn && total>=cpn.threshold ? cpn.value : 0;
  const pay=Math.max(0,total-discount);
  const oid="OD"+Date.now().toString().slice(-6);
  const logistics=[
    {time:new Date().toLocaleString(), desc:"è®¢å•åˆ›å»º"},
    {time:new Date(Date.now()+3600e3).toLocaleString(), desc:"ä»“åº“æ‹£è´§ä¸­"},
    {time:new Date(Date.now()+7200e3).toLocaleString(), desc:"å·²å‘å‡ºï¼Œè¿è¾“ä¸­"},
  ];
  S.orders.unshift({id:oid, items:structuredClone(S.cart.items), pay, status:"å¾…å‘è´§", channel, logistics});
  if(cpn) cpn.used=true;
  S.user.points += Math.round(pay*10*levelFactor());
  S.cart={items:[], couponId:null};
  save(); tip('æ”¯ä»˜æˆåŠŸ'); log('pay_ok',{oid,pay,channel}); closeDrawer(); render('me');
}

/* ============== ç‰©æµä¸åœ°å€ ============== */
function showLogistics(oid){
  const o=S.orders.find(x=>x.id===oid);
  const d=$("#drawer"); d.classList.add('show');
  d.innerHTML = `<div class="row"><b>ç‰©æµè·Ÿè¸ª</b><div class="space"></div><button class="chip" onclick="closeDrawer()">å…³é—­</button></div>
    <div style="border-left:2px solid var(--line);padding-left:10px;margin-top:8px">
      ${o.logistics.map(x=>`<div style="margin:8px 0"><b>${x.time}</b> - ${x.desc}</div>`).join('')}
    </div>`;
}
function saveAddr(){ S.user.address=$("#addr").value.trim(); save(); tip('å·²ä¿å­˜åœ°å€'); }
function levelFactor(){ const pts=S.user.points; if(pts>=7000) return 1.2; if(pts>=3000) return 1.1; if(pts>=1000) return 1.05; return 1; }
function getLevel(){ const pts=S.user.points; if(pts>=7000) return {level:'VIP'}; if(pts>=3000) return {level:'é‡‘å¡'}; if(pts>=1000) return {level:'é“¶å¡'}; return {level:'æ™®é€š'}; }

/* ============== åˆ¸ï¼šé¢†å–/æ ¸é”€ ============== */
function claimCoupon(id){ const c=S.coupons.find(x=>x.id===id); c.acquired=true; save(); tip('å·²é¢†å–ï¼š'+c.title); render('coupon'); }

/* ============== è§’è‰²åˆ‡æ¢ï¼ˆæƒé™æ¨¡æ‹Ÿï¼‰ ============== */
const ROLE_NAME={guest:'æ¸¸å®¢',operator:'è¿è¥',clerk:'åº—å‘˜',finance:'è´¢åŠ¡'};
function switchRole(){
  const next = S.role==='guest'?'operator':S.role==='operator'?'clerk':S.role==='clerk'?'finance':'guest';
  S.role=next; save();
  $("#roleTag").textContent='è§’è‰²ï¼š'+ROLE_NAME[S.role];
  tip('å·²åˆ‡æ¢ä¸º '+ROLE_NAME[S.role]);
  render(current);
}

/* ============== é¡¶éƒ¨äº¤äº’/æ—¥å¿—é¢æ¿/Tab ============== */
$("#btnScan").onclick=()=>render('scan');
$("#btnCart").onclick=openCart;
$("#btnRole").onclick=switchRole;
$("#btnLogs").onclick=()=>{
  const d=$("#drawer"); d.classList.add('show');
  const txt=S.logs.slice(0,160).map(l=>`${l.t} [${l.e}] ${JSON.stringify(l.p)}`).join('\n');
  d.innerHTML = `<div class="row"><b>åŸ‹ç‚¹æ—¥å¿—</b><div class="space"></div><button class="chip" onclick="closeDrawer()">å…³é—­</button></div>
  <pre style="white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1020;color:#c9e5ff;border-radius:12px;padding:10px;margin-top:8px">${txt||'æš‚æ— '}</pre>`;
};
$("#tabbar").addEventListener('click',e=>{
  const t=e.target.closest('.tab'); if(!t) return;
  const id=t.dataset.id; if(!id) return; render(id);
});
$("#globalSearch").addEventListener('keydown',e=>{ if(e.key==='Enter'){ render('shop'); }});

/* ============== å¯åŠ¨ ============== */
let current='home';
function render(page){ current=page||current||'home'; $$('#tabbar .tab').forEach(t=>t.classList.toggle('active', t.dataset.id===current)); const root=$("#app"); root.innerHTML=''; PAGES[current](root); updateCartCount(); log('page_view',{page:current}); }
render('home');
</script>
</body>
</html>
