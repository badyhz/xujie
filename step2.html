<!-- step2.htmlï¼ˆç²¾ç®€å¯ç”¨ç‰ˆï¼‰ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Step 2 - æ ‡ç­¾é€‰æ‹©ï¼ˆè¡Œä¸š/èŒä½=å•é€‰ï¼‰</title>
<style>
  body{margin:0;background:#f6f7fb;font-family:"Noto Sans SC",system-ui}
  .container{max-width:1080px;margin:0 auto;padding:18px}
  h1{margin:8px 0}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .panel{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,input[type=range]{padding:8px;border:1px solid #e5e7eb;border-radius:10px}
  .tag-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{padding:8px 10px;border-radius:999px;background:#eef6ff;border:1px solid #d0ebff;cursor:pointer}
  .chip.active{background:#d0ebff}
  .sel{display:flex;flex-direction:column;gap:8px;max-height:520px;overflow:auto}
  .item{background:#f8fbff;border:1px solid #e7f5ff;border-radius:12px;padding:10px;display:flex;gap:8px}
  .meta{flex:1}
  .pill{font-size:12px;background:#edf2ff;color:#3b5bdb;border-radius:999px;padding:2px 8px}
  .rm{background:#ffe3e3;color:#c92a2a;border:none;border-radius:8px;padding:6px 8px;cursor:pointer}
  .actions{display:flex;justify-content:space-between;gap:10px;margin-top:12px}
  button{padding:12px 18px;border:none;border-radius:10px;background:#4dabf7;color:#fff;cursor:pointer}
  .ghost{background:#e9ecef;color:#222}
</style>
</head>
<body>
<div class="container">
  <h1>Step 2 Â· ç¯å¢ƒä¸è¡Œä¸ºæ ‡ç­¾</h1>
  <div class="grid">
    <section class="panel">
      <h2>ğŸ¢ èŒä¸šçƒ™å°ï¼ˆå•é€‰ï¼‰</h2>
      <div class="row">
        <label>è¡Œä¸šï¼š</label>
        <select id="industry"></select>
        <label>å½±å“æƒé‡</label>
        <input id="wIndustry" type="range" min="1" max="10" value="5"/>
      </div>
      <div class="row" style="margin-top:8px">
        <label>èŒä½ï¼š</label>
        <select id="position"></select>
        <label>å½±å“æƒé‡</label>
        <input id="wPosition" type="range" min="1" max="10" value="5"/>
      </div>

      <h2 style="margin-top:18px">ğŸŒ å…¶ä»–æ ‡ç­¾ï¼ˆå¤šé€‰ + æƒé‡ï¼‰</h2>
      <div id="lib"></div>
    </section>

    <aside class="panel">
      <h2>âœ… å·²é€‰</h2>
      <div id="selected" class="sel"></div>
      <div class="actions">
        <button class="ghost" onclick="location.href='step1.html'">â¬… ä¸Šä¸€æ­¥</button>
        <button id="saveNext">ä¿å­˜å¹¶ç”ŸæˆæŠ¥å‘Š âœ</button>
      </div>
    </aside>
  </div>
</div>

<script>
/** è¡Œä¸š/èŒä½åˆ—è¡¨ï¼ˆç¤ºä¾‹ï¼‰ */
const INDUSTRIES = ["äº’è”ç½‘/è½¯ä»¶","äººå·¥æ™ºèƒ½","é‡‘è/æŠ•èµ„","åˆ¶é€ /å·¥ä¸š","åŒ»ç–—/åŒ»è¯","æ•™è‚²/åŸ¹è®­","åª’ä½“/å†…å®¹","ç”µå•†/é›¶å”®"];
const POSITIONS  = ["äº§å“ç»ç†","åç«¯å·¥ç¨‹å¸ˆ","ç®—æ³•å·¥ç¨‹å¸ˆ","æ•°æ®åˆ†æ","é”€å”®","è¿è¥","è®¾è®¡å¸ˆ","é¡¹ç›®ç»ç†"];

/** Big5 å½±å“å‘é‡ï¼ˆç¤ºä¾‹ï¼›å•ä½ï¼šåˆ†ï¼Œå»ºè®®èŒƒå›´ [-20,20]ï¼‰ */
const big5Delta = {
  // è¡Œä¸š
  "äº’è”ç½‘/è½¯ä»¶":[+5,+4,+2,0,0],
  "äººå·¥æ™ºèƒ½":[+6,+4,+1,0,+1],
  "é‡‘è/æŠ•èµ„":[-2,+7,0,-2,+2],
  "åˆ¶é€ /å·¥ä¸š":[-1,+6,-1,0,0],
  "åŒ»ç–—/åŒ»è¯":[0,+6,-1,+2,+1],
  "æ•™è‚²/åŸ¹è®­":[+2,+3,0,+3,0],
  "åª’ä½“/å†…å®¹":[+5,0,+2,0,+1],
  "ç”µå•†/é›¶å”®":[+2,+3,+2,0,0],
  // èŒä½
  "äº§å“ç»ç†":[+4,+5,+3,0,0],
  "åç«¯å·¥ç¨‹å¸ˆ":[+1,+5,-1,0,0],
  "ç®—æ³•å·¥ç¨‹å¸ˆ":[+3,+5,-1,0,+1],
  "æ•°æ®åˆ†æ":[+1,+4,-1,0,0],
  "é”€å”®":[0,0,+10,-3,+2],
  "è¿è¥":[0,+3,+2,0,0],
  "è®¾è®¡å¸ˆ":[+6,0,+1,0,0],
  "é¡¹ç›®ç»ç†":[0,+6,+2,0,0],
  // å…¶ä»–æ ‡ç­¾ï¼ˆä»…ä¸¾ä¾‹å‡ æ¡ï¼›ä½ å¯æ‰©å±•è‡³ 200ï¼‰
  "å¤œé—´æ´»è·ƒ":[+4,-2,0,0,+1],
  "ç¤¾äº¤å›é¿":[0,0,-8,+2,+4],
  "çŸ¥è¯†ä»˜è´¹":[+3,+1,0,0,0],
  "ç¾¤èŠä¸»å¯¼è€…":[0,0,+6,0,0]
};

/** å…¶ä»–æ ‡ç­¾åº“ï¼ˆç¤ºä¾‹ç‰‡æ®µï¼›è¯·æ›¿æ¢ä¸ºä½ çš„ 200 æ ‡ç­¾å¯¹è±¡åˆ—è¡¨ï¼‰ */
const OTHER_TAGS = [
  {category:"æ—¶é—´åˆ†é…", label:"å¤œé—´æ´»è·ƒ", desc:"å¤œæ™šæ•ˆç‡é«˜"},
  {category:"ç¤¾äº¤æŒ‡çº¹", label:"ç¤¾äº¤å›é¿", desc:"é€€ç¼©ä¸èƒ½é‡ä¿æŠ¤"},
  {category:"æ¶ˆè´¹å°è®°", label:"çŸ¥è¯†ä»˜è´¹", desc:"ä»¥å­¦ä¹ ä¸ºä¸»è¦æŠ•å…¥"},
  {category:"ç¤¾äº¤æŒ‡çº¹", label:"ç¾¤èŠä¸»å¯¼è€…", desc:"è¯é¢˜é©±åŠ¨ä¸ç»„ç»‡åŠ›"}
];

/** æ¸²æŸ“ï¼šè¡Œä¸š/èŒä½ï¼ˆå•é€‰ï¼‰ */
const selInd = document.getElementById('industry');
const selPos = document.getElementById('position');
selInd.innerHTML = INDUSTRIES.map(x=>`<option>${x}</option>`).join('');
selPos.innerHTML = POSITIONS.map(x=>`<option>${x}</option>`).join('');

/** æ¸²æŸ“ï¼šå…¶ä»–æ ‡ç­¾ï¼ˆchip å¯é€‰ï¼Œå³ä¾§æƒé‡å¯è°ƒï¼‰ */
const libBox = document.getElementById('lib');
function renderLibrary(){
  // åˆ†ç»„æ˜¾ç¤º
  const byCat = {};
  OTHER_TAGS.forEach(t=>{ (byCat[t.category]??=[]).push(t); });
  libBox.innerHTML = Object.keys(byCat).map(cat=>{
    const chips = byCat[cat].map(t=>`<span class="chip" data-cat="${cat}" data-lab="${t.label}" title="${t.desc}">${t.label}</span>`).join('');
    return `<h3>${cat}</h3><div class="tag-grid">${chips}</div>`;
  }).join('');
  libBox.addEventListener('click', e=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    const cat = chip.dataset.cat, lab = chip.dataset.lab;
    toggleOther({category:cat,label:lab,desc:OTHER_TAGS.find(x=>x.label===lab)?.desc || ""});
    chip.classList.toggle('active');
  }, {once:true});
}

/** çŠ¶æ€ï¼šå·²é€‰ */
const state = { selected: [] };
function upsertItem(item){
  const i = state.selected.findIndex(x=>x.category===item.category && x.label===item.label);
  if(i>=0) state.selected[i]=item; else state.selected.push(item);
}
function removeItem(item){
  const i = state.selected.findIndex(x=>x.category===item.category && x.label===item.label);
  if(i>=0) state.selected.splice(i,1);
}
function toggleOther(t){
  const i = state.selected.findIndex(x=>x.category===t.category && x.label===t.label);
  if(i>=0) state.selected.splice(i,1); else state.selected.push({...t, weight:5});
  renderSelected();
}
function renderSelected(){
  const box=document.getElementById('selected');
  if(!state.selected.length){ box.innerHTML='<div style="color:#6c757d">æš‚æ— é€‰æ‹©</div>'; return; }
  box.innerHTML = state.selected.map((s,i)=>`
    <div class="item">
      <div class="meta">
        <div><strong>${s.label}</strong> <span class="pill">${s.category}</span></div>
        <div style="font-size:12px;color:#6c757d">${s.desc||""}</div>
        <div class="row" style="margin-top:6px">
          <label>å½±å“æƒé‡</label>
          <input type="range" min="1" max="10" value="${s.weight||5}" oninput="state.selected[${i}].weight=this.value"/>
        </div>
      </div>
      <button class="rm" onclick="state.selected.splice(${i},1);renderSelected()">ç§»é™¤</button>
    </div>
  `).join('');
}

/** è®¡ç®—ï¼šç¯å¢ƒå¤§äº”ï¼ˆè¡Œä¸šå•é€‰ + èŒä½å•é€‰ + å…¶ä»–æ ‡ç­¾[*æƒé‡]ï¼‰ */
function clamp01(x){ return Math.max(0, Math.min(100, Math.round(x))); }
function addVec(a=[],b=[]){ return a.map((v,i)=>(v||0)+(b[i]||0)); }
function weightedEnvBig5(){
  const baseline = [50,50,50,50,50];

  // è¡Œä¸šï¼ˆå•é€‰ï¼‰
  const ind = selInd.value;
  const wI = parseInt(document.getElementById('wIndustry').value,10)||5;
  let acc = [0,0,0,0,0], wSum=0;
  if(big5Delta[ind]){ acc = addVec(acc, big5Delta[ind].map(x=>x*wI)); wSum += wI; }

  // èŒä½ï¼ˆå•é€‰ï¼‰
  const pos = selPos.value;
  const wP = parseInt(document.getElementById('wPosition').value,10)||5;
  if(big5Delta[pos]){ acc = addVec(acc, big5Delta[pos].map(x=>x*wP)); wSum += wP; }

  // å…¶ä»–æ ‡ç­¾ï¼ˆå¤šé€‰ï¼‰
  state.selected.forEach(s=>{
    const v = big5Delta[s.label] || [0,0,0,0,0];
    const w = parseInt(s.weight||5,10);
    acc = addVec(acc, v.map(x=>x*w)); wSum += w;
  });

  const delta = wSum ? acc.map(x=>x/wSum) : [0,0,0,0,0];
  return baseline.map((b,i)=>clamp01(b + delta[i]));
}

/** å››æ¶²è´¨æ˜ å°„ï¼ˆå¤ç”¨ Step1 å…¬å¼ï¼‰ */
function bigFiveToTemperaments([O,C,E,A,N]){
  const ES=100-N;
  let S=0.5*E+0.3*O+0.2*ES;
  let Ch=0.4*E+0.4*C-0.2*A+0.2*ES;
  let M=0.5*N+0.2*C-0.2*E+0.1*A;
  let P=0.4*A+0.3*ES+0.2*C-0.1*E;
  S=Math.max(0,S);Ch=Math.max(0,Ch);M=Math.max(0,M);P=Math.max(0,P);
  const sum=S+Ch+M+P || 1;
  return {å¤šè¡€è´¨:Math.round(S/sum*100),èƒ†æ±è´¨:Math.round(Ch/sum*100),æŠ‘éƒè´¨:Math.round(M/sum*100),ç²˜æ¶²è´¨:Math.round(P/sum*100)};
}

/** ä¿å­˜å¹¶è·³è½¬ */
document.getElementById('saveNext').addEventListener('click', ()=>{
  // å°†è¡Œä¸š/èŒä½ä¹Ÿå†™å…¥ selectedTagsï¼ˆåˆ†åˆ«ä¸¤æ¡ï¼‰
  const wI = parseInt(document.getElementById('wIndustry').value,10)||5;
  const wP = parseInt(document.getElementById('wPosition').value,10)||5;
  const sel = [
    {label: selInd.value, category:"è¡Œä¸š", desc:"èŒä¸šè¡Œä¸šå•é€‰", weight:wI},
    {label: selPos.value, category:"èŒä½", desc:"èŒä¸šèŒä½å•é€‰", weight:wP},
    ...state.selected
  ];
  localStorage.setItem('selectedTags', JSON.stringify(sel));

  const envBig5 = weightedEnvBig5();
  const envTemp = bigFiveToTemperaments(envBig5);
  localStorage.setItem('envScores', JSON.stringify(envBig5));
  localStorage.setItem('temperamentEnv', JSON.stringify(envTemp));

  window.location.assign('report.html');
});

/** åˆå§‹åŒ– */
renderLibrary();
renderSelected();
</script>
</body>
</html>
