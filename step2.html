<!-- step2.html（精简可用版） -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Step 2 - 标签选择（行业/职位=单选）</title>
<style>
  body{margin:0;background:#f6f7fb;font-family:"Noto Sans SC",system-ui}
  .container{max-width:1080px;margin:0 auto;padding:18px}
  h1{margin:8px 0}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .panel{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,input[type=range]{padding:8px;border:1px solid #e5e7eb;border-radius:10px}
  .tag-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{padding:8px 10px;border-radius:999px;background:#eef6ff;border:1px solid #d0ebff;cursor:pointer}
  .chip.active{background:#d0ebff}
  .sel{display:flex;flex-direction:column;gap:8px;max-height:520px;overflow:auto}
  .item{background:#f8fbff;border:1px solid #e7f5ff;border-radius:12px;padding:10px;display:flex;gap:8px}
  .meta{flex:1}
  .pill{font-size:12px;background:#edf2ff;color:#3b5bdb;border-radius:999px;padding:2px 8px}
  .rm{background:#ffe3e3;color:#c92a2a;border:none;border-radius:8px;padding:6px 8px;cursor:pointer}
  .actions{display:flex;justify-content:space-between;gap:10px;margin-top:12px}
  button{padding:12px 18px;border:none;border-radius:10px;background:#4dabf7;color:#fff;cursor:pointer}
  .ghost{background:#e9ecef;color:#222}
</style>
</head>
<body>
<div class="container">
  <h1>Step 2 · 环境与行为标签</h1>
  <div class="grid">
    <section class="panel">
      <h2>🏢 职业烙印（单选）</h2>
      <div class="row">
        <label>行业：</label>
        <select id="industry"></select>
        <label>影响权重</label>
        <input id="wIndustry" type="range" min="1" max="10" value="5"/>
      </div>
      <div class="row" style="margin-top:8px">
        <label>职位：</label>
        <select id="position"></select>
        <label>影响权重</label>
        <input id="wPosition" type="range" min="1" max="10" value="5"/>
      </div>

      <h2 style="margin-top:18px">🌍 其他标签（多选 + 权重）</h2>
      <div id="lib"></div>
    </section>

    <aside class="panel">
      <h2>✅ 已选</h2>
      <div id="selected" class="sel"></div>
      <div class="actions">
        <button class="ghost" onclick="location.href='step1.html'">⬅ 上一步</button>
        <button id="saveNext">保存并生成报告 ➜</button>
      </div>
    </aside>
  </div>
</div>

<script>
/** 行业/职位列表（示例） */
const INDUSTRIES = ["互联网/软件","人工智能","金融/投资","制造/工业","医疗/医药","教育/培训","媒体/内容","电商/零售"];
const POSITIONS  = ["产品经理","后端工程师","算法工程师","数据分析","销售","运营","设计师","项目经理"];

/** Big5 影响向量（示例；单位：分，建议范围 [-20,20]） */
const big5Delta = {
  // 行业
  "互联网/软件":[+5,+4,+2,0,0],
  "人工智能":[+6,+4,+1,0,+1],
  "金融/投资":[-2,+7,0,-2,+2],
  "制造/工业":[-1,+6,-1,0,0],
  "医疗/医药":[0,+6,-1,+2,+1],
  "教育/培训":[+2,+3,0,+3,0],
  "媒体/内容":[+5,0,+2,0,+1],
  "电商/零售":[+2,+3,+2,0,0],
  // 职位
  "产品经理":[+4,+5,+3,0,0],
  "后端工程师":[+1,+5,-1,0,0],
  "算法工程师":[+3,+5,-1,0,+1],
  "数据分析":[+1,+4,-1,0,0],
  "销售":[0,0,+10,-3,+2],
  "运营":[0,+3,+2,0,0],
  "设计师":[+6,0,+1,0,0],
  "项目经理":[0,+6,+2,0,0],
  // 其他标签（仅举例几条；你可扩展至 200）
  "夜间活跃":[+4,-2,0,0,+1],
  "社交回避":[0,0,-8,+2,+4],
  "知识付费":[+3,+1,0,0,0],
  "群聊主导者":[0,0,+6,0,0]
};

/** 其他标签库（示例片段；请替换为你的 200 标签对象列表） */
const OTHER_TAGS = [
  {category:"时间分配", label:"夜间活跃", desc:"夜晚效率高"},
  {category:"社交指纹", label:"社交回避", desc:"退缩与能量保护"},
  {category:"消费印记", label:"知识付费", desc:"以学习为主要投入"},
  {category:"社交指纹", label:"群聊主导者", desc:"话题驱动与组织力"}
];

/** 渲染：行业/职位（单选） */
const selInd = document.getElementById('industry');
const selPos = document.getElementById('position');
selInd.innerHTML = INDUSTRIES.map(x=>`<option>${x}</option>`).join('');
selPos.innerHTML = POSITIONS.map(x=>`<option>${x}</option>`).join('');

/** 渲染：其他标签（chip 可选，右侧权重可调） */
const libBox = document.getElementById('lib');
function renderLibrary(){
  // 分组显示
  const byCat = {};
  OTHER_TAGS.forEach(t=>{ (byCat[t.category]??=[]).push(t); });
  libBox.innerHTML = Object.keys(byCat).map(cat=>{
    const chips = byCat[cat].map(t=>`<span class="chip" data-cat="${cat}" data-lab="${t.label}" title="${t.desc}">${t.label}</span>`).join('');
    return `<h3>${cat}</h3><div class="tag-grid">${chips}</div>`;
  }).join('');
  libBox.addEventListener('click', e=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    const cat = chip.dataset.cat, lab = chip.dataset.lab;
    toggleOther({category:cat,label:lab,desc:OTHER_TAGS.find(x=>x.label===lab)?.desc || ""});
    chip.classList.toggle('active');
  }, {once:true});
}

/** 状态：已选 */
const state = { selected: [] };
function upsertItem(item){
  const i = state.selected.findIndex(x=>x.category===item.category && x.label===item.label);
  if(i>=0) state.selected[i]=item; else state.selected.push(item);
}
function removeItem(item){
  const i = state.selected.findIndex(x=>x.category===item.category && x.label===item.label);
  if(i>=0) state.selected.splice(i,1);
}
function toggleOther(t){
  const i = state.selected.findIndex(x=>x.category===t.category && x.label===t.label);
  if(i>=0) state.selected.splice(i,1); else state.selected.push({...t, weight:5});
  renderSelected();
}
function renderSelected(){
  const box=document.getElementById('selected');
  if(!state.selected.length){ box.innerHTML='<div style="color:#6c757d">暂无选择</div>'; return; }
  box.innerHTML = state.selected.map((s,i)=>`
    <div class="item">
      <div class="meta">
        <div><strong>${s.label}</strong> <span class="pill">${s.category}</span></div>
        <div style="font-size:12px;color:#6c757d">${s.desc||""}</div>
        <div class="row" style="margin-top:6px">
          <label>影响权重</label>
          <input type="range" min="1" max="10" value="${s.weight||5}" oninput="state.selected[${i}].weight=this.value"/>
        </div>
      </div>
      <button class="rm" onclick="state.selected.splice(${i},1);renderSelected()">移除</button>
    </div>
  `).join('');
}

/** 计算：环境大五（行业单选 + 职位单选 + 其他标签[*权重]） */
function clamp01(x){ return Math.max(0, Math.min(100, Math.round(x))); }
function addVec(a=[],b=[]){ return a.map((v,i)=>(v||0)+(b[i]||0)); }
function weightedEnvBig5(){
  const baseline = [50,50,50,50,50];

  // 行业（单选）
  const ind = selInd.value;
  const wI = parseInt(document.getElementById('wIndustry').value,10)||5;
  let acc = [0,0,0,0,0], wSum=0;
  if(big5Delta[ind]){ acc = addVec(acc, big5Delta[ind].map(x=>x*wI)); wSum += wI; }

  // 职位（单选）
  const pos = selPos.value;
  const wP = parseInt(document.getElementById('wPosition').value,10)||5;
  if(big5Delta[pos]){ acc = addVec(acc, big5Delta[pos].map(x=>x*wP)); wSum += wP; }

  // 其他标签（多选）
  state.selected.forEach(s=>{
    const v = big5Delta[s.label] || [0,0,0,0,0];
    const w = parseInt(s.weight||5,10);
    acc = addVec(acc, v.map(x=>x*w)); wSum += w;
  });

  const delta = wSum ? acc.map(x=>x/wSum) : [0,0,0,0,0];
  return baseline.map((b,i)=>clamp01(b + delta[i]));
}

/** 四液质映射（复用 Step1 公式） */
function bigFiveToTemperaments([O,C,E,A,N]){
  const ES=100-N;
  let S=0.5*E+0.3*O+0.2*ES;
  let Ch=0.4*E+0.4*C-0.2*A+0.2*ES;
  let M=0.5*N+0.2*C-0.2*E+0.1*A;
  let P=0.4*A+0.3*ES+0.2*C-0.1*E;
  S=Math.max(0,S);Ch=Math.max(0,Ch);M=Math.max(0,M);P=Math.max(0,P);
  const sum=S+Ch+M+P || 1;
  return {多血质:Math.round(S/sum*100),胆汁质:Math.round(Ch/sum*100),抑郁质:Math.round(M/sum*100),粘液质:Math.round(P/sum*100)};
}

/** 保存并跳转 */
document.getElementById('saveNext').addEventListener('click', ()=>{
  // 将行业/职位也写入 selectedTags（分别两条）
  const wI = parseInt(document.getElementById('wIndustry').value,10)||5;
  const wP = parseInt(document.getElementById('wPosition').value,10)||5;
  const sel = [
    {label: selInd.value, category:"行业", desc:"职业行业单选", weight:wI},
    {label: selPos.value, category:"职位", desc:"职业职位单选", weight:wP},
    ...state.selected
  ];
  localStorage.setItem('selectedTags', JSON.stringify(sel));

  const envBig5 = weightedEnvBig5();
  const envTemp = bigFiveToTemperaments(envBig5);
  localStorage.setItem('envScores', JSON.stringify(envBig5));
  localStorage.setItem('temperamentEnv', JSON.stringify(envTemp));

  window.location.assign('report.html');
});

/** 初始化 */
renderLibrary();
renderSelected();
</script>
</body>
</html>
